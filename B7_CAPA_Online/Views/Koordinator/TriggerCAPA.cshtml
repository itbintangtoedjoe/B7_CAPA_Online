

<style>
    @@media (min-width: 768px) {
        .modal-xl {
            width: 900%;
            max-width: 1400px;
        }
    }
</style>

<div class="modal fade" id="link_CCC" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Filter</h5>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group col-md-6">
                        <label for="TxtTahunCCC" class="col-form-label">Tahun:</label>
                        <div class="input-group">
                            <select class="form-control select2 TahunCCC" name="TahunCCC" id="Tahun_DDL" required>
                            </select>
                        </div>
                    </div>
                    <div class="form-group col-md-6">
                        <label for="TxtPlantCCC" class="col-form-label">Plant:</label>
                        <div class="input-group ">
                            <select class="form-control select2" id="Plant_DDL" required>
                            </select>
                        </div>
                    </div>
                    <div class="form-group col-md-6">
                        <label for="TxtKategoriCCC" class="col-form-label">Jenis Kategori:</label>
                        <div class="input-group">
                            <select class="form-control select2" id="JenisKategori_DDL" required>
                                <option value="JUSTIFIED">Justified</option>
                                <option value="UNJUSTIFIED">Unjustified</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group col-md-6">
                        <label for="TxtKeluhanCCC" class="col-form-label">Jenis Keluhan:</label>
                        <div class="input-group">
                            <select class="form-control select2" id="JenisKeluhan_DDL" required>
                                <option value="Quality">Quality</option>
                                <option value="Health">Health</option>
                                <option value="Promotion">Promotion</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group col-md-6">
                        <button type="button" class="btn btn-primary" id="btn_Search_CCC">Search</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered zero-configuration" id="Tbl_CCC">
                            <thead>
                                <tr>
                                    <th>Action</th>
                                    <th>No CCC</th>
                                    <th>Tipe</th>
                                    <th>Nama Produk</th>
                                    <th>Batch</th>
                                    <th>Keluhan</th>
                                    <th>Site</th>
                                    <th>Kategori</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" id="btn_Close_CCC">Close</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="link_Deviation" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Filter</h5>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group col-md-6">
                        <label for="TxtTahunDeviation" class="col-form-label">Tahun:</label>
                        <div class="input-group">
                            <select class="form-control select2" name="TahunDeviation" id="Tahun_DDL_Deviaton" required>
                            </select>
                        </div>
                    </div>
                    <div class="form-group col-md-6">
                        <label for="TxtDepartemenDeviation" class="col-form-label">Departemen:</label>
                        <div class="input-group ">
                            <select class="form-control select2" id="DepartemenPelapor_DDL" required>
                            </select>
                        </div>
                    </div>
                    <div class="form-group col-md-6">
                        <label for="TxtKategoriDeviation" class="col-form-label">Kategori Penyimpangan:</label>
                        <div class="input-group">
                            <select class="form-control select2" id="KategoriPenyimpangan_DDL" required>
                            </select>
                        </div>
                    </div>
                    <div class="form-group col-md-6">
                        <label for="TxtJenisPenyimpangan" class="col-form-label">Jenis Penyimpangan:</label>
                        <div class="input-group">
                            <select class="form-control select2" id="JenisPenyimpangan_DDL" required>
                                <option value="Yes">Terencana</option>
                                <option value="No">Tidak Terencana</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group col-md-6">
                        <button type="button" class="btn btn-primary" id="btn_Search_Deviation">Search</button>
                    </div>

                    <table id="tblDeviation" class="table table-bordered dt-responsive nowrap" style="border-collapse: collapse; border-spacing: 0; width: 100%;">
                        <thead>
                            <tr>
                                <th>Action</th>
                                <th>No Penyimpangan</th>
                                <th>Nama Pelapor</th>
                                <th>Kategori Penyimpangan</th>
                                <th>Jenis Penyimpangan</th>
                                <th>Deskripsi Singkat</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                            </tr>
                        </tbody>
                    </table>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal" id="btn_Close_Deviaton">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="link_CAPA" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Filter</h5>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group col-md-6">
                        <label for="TxtTahunDeviation" class="col-form-label">Tahun:</label>
                        <div class="input-group">
                            <select class="form-control select2" name="TahunDeviation" id="Tahun_DDL_CAPA" required>
                            </select>
                        </div>
                    </div>
                    <div class="form-group col-md-6">
                        <label for="TxtJenisPenyimpangan" class="col-form-label">Lokasi CAPA:</label>
                        <div class="input-group">
                            <select class="form-control select2" id="Lokasi_CAPA" required>
                            </select>
                        </div>
                    </div>
                    <div class="form-group col-md-6">
                        <label for="TxtDepartemenDeviation" class="col-form-label">Departemen:</label>
                        <div class="input-group ">
                            <select class="form-control select2" id="DepartemenPelapor_CAPA" required>
                            </select>
                        </div>
                    </div>
                    <div class="form-group col-md-6">
                        <label for="TxtKategoriDeviation" class="col-form-label">Kategori CAPA:</label>
                        <div class="input-group">
                            <select class="form-control select2" id="Kategori_CAPA" required>
                            </select>
                        </div>
                    </div>
                    <div class="form-group col-md-6">
                        <label for="TxtJenisPenyimpangan" class="col-form-label">Kode CAPA:</label>
                        <div class="input-group">
                            <select class="form-control select2" id="Kode_CAPA" required>
                                <option value="Yes">Terencana</option>
                                <option value="No">Tidak Terencana</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group col-md-6">
                        <button type="button" class="btn btn-primary" id="btn_Search_CAPA">Search</button>
                    </div>
                    <div class="col-md-8">
                        <table id="tblCAPA" class="table table-bordered dt-responsive nowrap" style="border-collapse: collapse; border-spacing: 0; width: 100%;">
                            <thead>
                                <tr>
                                    <th>Action</th>
                                    <th>No CAPA</th>
                                    <th>PIC CAPA</th>
                                    <th>Departemen</th>
                                    <th>Site</th>
                                    <th>Kategori CAPA</th>
                                    <th>Kode CAPA</th>
                                    <th>Deskripsi Singkat</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal" id="btn_Close_CAPA">Close</button>
            </div>
        </div>
    </div>
</div>
<div class="card">
    <div class="card-body">
        <div class="row form-group-sm">
            <div class="col-md-6">
                <label class="m-t-20">Trigger CAPA</label>
                <select class="form-control form-control-sm" id="Trigger_CAPA">
                    <option value="Oracle">ATB</option>
                    <option value="Oracle">PMTMS</option>
                    <option value="CCC">Kembalian Terkait Kualitas</option>
                </select>
            </div>
        </div>
        <div class="row form-group" id="Linked_Deviation" hidden="hidden">
            <div class="col-md-6">
                <label class="m-t-20">Penyimpangan Terkait</label>
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <button class="btn btn-outline-dark" type="button" data-toggle="modal" id="browse_Deviation" data-target="#link_Deviation" data-backdrop="static" data-keyboard="false">Browse</button>
                    </div>
                    <input type="text" class="form-control" id="txt_Deviation" placeholder="Generate Link">
                </div>
            </div>
        </div>
        <div class="row form-group" id="Linked_CAPA" hidden="hidden">
            <div class="col-md-6">
                <label class="m-t-40">CAPA Terkait</label>
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <button class="btn btn-outline-dark" type="button" id="browse_CAPA" data-toggle="modal" data-target="#link_CAPA" data-backdrop="static" data-keyboard="false">Browse</button>
                    </div>
                    <input type="text" class="form-control" id="txt_CAPA" placeholder="Generate Link">
                </div>
            </div>
        </div>
        <div class="row form-group" id="Linked_CCC" hidden="hidden">
            <div class="col-md-6">
                <label class="m-t-40">Keluhan Pelanggan Terkait</label>
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <button class="btn btn-outline-dark" type="button" id="browse_CCC" data-toggle="modal" data-target="#link_CCC" data-backdrop="static" data-keyboard="false">Browse</button>
                    </div>
                    <input type="text" class="form-control" id="txt_CCC" placeholder="Generate Link">
                </div>
            </div>
        </div>
        <div class="row form-group-sm mb-2" id="Lampiran">
            <div class="col-md-6">
                <label class="m-t-20">Lampiran Terkait</label>
                <div class="input-group mb-3">
                    <div class="custom-file">
                        <input id="TxtFileInput" type="file" name="LampiranTerkait" class="custom-file-input" onclick="this.value = null" multiple required">

                        <label id="TxtLampiranCount" class="custom-file-label"></label>
                    </div>
                </div>
            </div>
        </div>
        <br />
        <input type="button" class="btn btn-primary" id="Submit" value="Upload" />
        <div class="row form-group-sm" id="List_Penyimpangan" hidden>
            <div class="col-md-6">
                <label class="m-t-20">List Penyimpangan</label>
                <div class="table-responsive">
                    <table class="table table-hover table-bordered zero-configuration" id="Tbl_Penyimpangan" style="color: black">
                        <thead>
                            <tr>
                                <th></th>
                                <th>Penyimpangan</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <br />
        <div class="row form-group-sm" id="List_Lampiran" hidden>
            <div class="col-md-6">
                <label class="m-t-20">List Lampiran</label>
                <div class="table-responsive">
                    <table class="table table-hover table-bordered zero-configuration" id="Tbl_Lampiran" style="color: black">
                        <thead>
                            <tr>
                                <th></th>
                                <th>Lampiran</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody style="color: black">
                            <tr>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>


<script src="~/Content/Scripts/js/sweetalert2.all.min.js"></script>


<script>
    var QSNoCAPA = getQueryStrings()["NoCAPA"];
    var loginusernik = '@Request.RequestContext.HttpContext.Session["NIK"]';
    var Jsondevi = [];
    function getQueryStrings() {
        var vars = [], hash;
        var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
        for (var i = 0; i < hashes.length; i++) {
            hash = hashes[i].split('=');
            vars.push(hash[0]);
            vars[hash[0]] = hash[1];
        }
        return vars;
    }
    $(document).ready(function () {
        getDDL();
        TahunDDL();

        $('#AreaPIC_DDL').select2();
        $('#PIC_DDL').select2();
        $('#Departemen_DDL').select2().append();
        $('#Trigger_CAPA').change(function () {
            clearHidden();
            //if ($('#Trigger_CAPA').val() == "PENYIMPANGAN") {
            //    $('#Linked_Oracle').prop('hidden', false);
            //} else if ($('#Trigger_CAPA').val() == "CCC") {
            //    $('#Linked_CCC').prop('hidden', false);
            //} else if ($('#Trigger_CAPA').val() == "CAPA") {
            //    $('#Linked_CAPA').prop('hidden', false);
            //}
        });
        $('#TxtFileInput').change(function () {
            fileCount = this.files.length;
            var teks = (fileCount != 0) ? (fileCount + " Lampiran telah dipilih.") : ("");
            $('#TxtLampiranCount').text(teks);
        })
        $('#Submit').click(function () {
            Submit();
        });

        $('#btn_Add').click(function () {
            AddDepartemen();
            $('#VendorDiv').prop('hidden', true);
        });

        $('#btn_Close_CCC').click(function () {
            var Jsonobj = [];
            var status = false;
            var table = $('#Tbl_CCC').DataTable();
            for (var i = 0; i < table.data().count(); i++) {

                var creator = loginusernik;
                var row = table.row(i);
                var tr = $(row.node());
                var checkbox = tr.find('td:first-child input[type="checkbox"]')
                // Mengecheck Checkbox apakah sudah di checklist
                if (checkbox.is(':checked')) {
                    var data = row.data();
                    var item = {};
                    item["NoCapa"] = QSNoCAPA;
                    item["PenyimpanganID"] = data['No_CCC'];
                    item["Description"] = "CCC";
                    item["Creator"] = creator;
                    Jsonobj.push(item);
                    status = true;
                }
            }
            if (status == true) {
                var dto = {
                    Penyimpangan: Jsonobj
                }
                $.ajax({
                    url: 'InsertAddAbleDeviation',
                    type: 'post',
                    dataType: 'json',
                    data: JSON.stringify(dto),
                    contentType: 'application/json; charset=utf-8',
                    success: function (data) {

                        Swal.fire({
                            title: "Success!",
                            text: 'Transaction berhasil di Insert!',
                            icon: "success",
                            showConfirmButton: false,
                            timer: 1000,
                        })
                        $('#Tbl_CCC').DataTable().clear().destroy();
                        GetPenyimpangan();
                    },
                    error: function (ex) {
                        alert(JSON.stringify(ex));
                    }
                });

            }

        });

        $('#btn_Close_CAPA').click(function () {

            var Jsonobj = [];
            var status = false;
            var table = $('#tblCAPA').DataTable();
            for (var i = 0; i < table.data().count(); i++) {

                var creator = loginusernik;
                var row = table.row(i);
                var tr = $(row.node());
                var checkbox = tr.find('td:first-child input[type="checkbox"]')
                // Mengecheck Checkbox apakah sudah di checklist
                if (checkbox.is(':checked')) {
                    var data = row.data();
                    var item = {};
                    item["NoCapa"] = QSNoCAPA;
                    item["PenyimpanganID"] = data['NO_CAPA'];
                    item["Description"] = "CAPA";
                    item["Creator"] = creator;
                    Jsonobj.push(item);
                    status = true;
                }
            }

            if (status == true) {
                var dto = {
                    Penyimpangan: Jsonobj
                }
                $.ajax({
                    url: 'InsertAddAbleDeviation',
                    type: 'post',
                    dataType: 'json',
                    data: JSON.stringify(dto),
                    contentType: 'application/json; charset=utf-8',
                    success: function (data) {

                        Swal.fire({
                            title: "Success!",
                            text: 'Transaction berhasil di Insert!',
                            icon: "success",
                            showConfirmButton: false,
                            timer: 1000,
                        })
                        $('#tblCAPA').DataTable().clear().destroy();

                    },
                    error: function (ex) {
                        alert(JSON.stringify(ex));
                    }
                });

            }

        });

        $('#btn_Close_Deviaton').click(function () {
            var Jsonobj = [];
            var status = false;
            var table = $('#tblDeviation').DataTable();
            for (var i = 0; i < table.data().count(); i++) {

                var creator = loginusernik;
                var row = table.row(i);
                var tr = $(row.node());
                var checkbox = tr.find('td:first-child input[type="checkbox"]')
                // Mengecheck Checkbox apakah sudah di checklist
                if (checkbox.is(':checked')) {
                    var data = row.data();
                    var item = {};
                    item["NoCapa"] = QSNoCAPA;
                    item["PenyimpanganID"] = data['DEVIATION_NO'];
                    item["Description"] = "DEVIATION";
                    item["Creator"] = creator;
                    Jsonobj.push(item);
                    status = true;
                }
            }

            if (status == true) {
                var dto = {
                    Penyimpangan: Jsonobj
                }
                $.ajax({
                    url: 'InsertAddAbleDeviation',
                    type: 'post',
                    dataType: 'json',
                    data: JSON.stringify(dto),
                    contentType: 'application/json; charset=utf-8',
                    success: function (data) {

                        Swal.fire({
                            title: "Success!",
                            text: 'Transaction berhasil di Insert!',
                            icon: "success",
                            showConfirmButton: false,
                            timer: 1000,
                        })
                        $('#tblDeviation').DataTable().clear().destroy();
                        GetPenyimpangan();
                    },
                    error: function (ex) {
                        alert(JSON.stringify(ex));
                    }
                });

            }

        });

        $('#Lokasi_DDL').change(function () {
            var Location;

            if ($('#Lokasi_DDL').val() == 'CKG') {
                Location = 'Cikarang';
            } else if ($('#Lokasi_DDL').val() == 'HOF') {
                Location = 'Head Office';
            } else {
                Location = 'Pulogadung';
            }
            dto = {
                Option: 3,
                Departemen: $('#AreaPIC_DDL').val(),
                Lokasi: Location,
                SP: "[dbo].[SP_SHOW_DDL]"
            }

            $.ajax({
                url: 'GetDepartments',
                type: 'post',
                dataType: 'json',
                data: JSON.stringify({
                    Option: 2,
                    Lokasi: Location,
                    SP: "[dbo].[SP_SHOW_DDL]"
                }),
                contentType: 'application/json; charset=utf-8',
                success: function (data) {
                    $('#Departemen_DDL').empty();
                    $('#Departemen_DDL').append($('<option></option>').attr('value', '').text('*Pilih*'));
                    $.each(JSON.parse(data), function (key, entry) {
                        $('#Departemen_DDL').append($('<option></option>').attr('value', entry.SubDept).text(entry.SubDept));
                        $('#DepartemenPelapor_DDL').append($('<option></option>').attr('value', entry.SubDeptCode).text(entry.SubDept));
                    })
                    $('#Departemen_DDL').append($('<option></option>').attr('value', 'Others').text('Others'));
                    $('#Departemen_DDL').select2();
                },
                error: function (ex) {
                    alert(JSON.stringify(ex));
                }
            });

            //$.ajax({
            //    url: 'GetSupervisors',
            //    type: 'post',
            //    data: JSON.stringify(dto),
            //    dataType: 'json',
            //    contentType: 'application/json; charset=utf-8',
            //    success: function (data) {
            //        $('#PIC_DDL').empty();
            //        $.each(JSON.parse(data), function (key, entry) {
            //            $('#PIC_DDL').append($('<option></option>').attr('value', entry.EmpName).text(entry.EmpName));
            //        });

            //        if ($('#PIC_DDL').val() == null) {
            //            $('#PIC_DDL').append($('<option></option>').attr('value', '').text('None'));
            //        }

            //        $('#PIC_DDL').select2();
            //    },
            //    error: function (ex) {
            //        alert(JSON.stringify(ex));
            //    }
            //});
        });

        $('#AreaPIC_DDL').change(function () {
            var Location;
            $('#VendorDiv').prop('hidden', true);

            if ($('#Lokasi_DDL').val() == 'CKG') {
                Location = 'Cikarang';
            } else if ($('#Lokasi_DDL').val() == 'HOF') {
                Location = 'Head Office';
            } else {
                Location = 'Pulogadung';
            }
            dto = {
                Option: 3,
                Departemen: $('#AreaPIC_DDL').val(),
                Lokasi: Location,
                SP: "[dbo].[SP_SHOW_DDL]"
            }

            $.ajax({
                url: 'GetSupervisors',
                type: 'post',
                data: JSON.stringify(dto),
                dataType: 'json',
                contentType: 'application/json; charset=utf-8',
                success: function (data) {
                    $('#PIC_DDL').empty();
                    if ($('#AreaPIC_DDL').val() != 'Others') {
                        $.each(JSON.parse(data), function (key, entry) {
                            $('#PIC_DDL').append(new Option(entry.EmpName, entry.EmpName));
                        });
                    } else {
                        $('#VendorDiv').prop('hidden', false);
                        $.each(JSON.parse(data), function (key, entry) {
                            $('#PIC_DDL').append($('<option></option>').attr('value', entry.DDL_CODE).text(entry.DDL_DESCRIPTION));
                        });
                    }
                    if ($('#PIC_DDL').val() == null) {
                        $('#PIC_DDL').append($('<option></option>').attr('value', '').text('None'));
                    }

                    $('#PIC_DDL').select2();
                },
                error: function (ex) {
                    alert(JSON.stringify(ex));
                }
            });
            //_callback();
        });

        $('#btn_Search_Deviation').click(function () {
            dto = {
                Option: 1,
                NoCapa: QSNoCAPA,
                Departemen: $('#DepartemenPelapor_DDL').val(),
                JenisPenyimpangan: $('#JenisPenyimpangan_DDL').val(),
                Kategori: $('#KategoriPenyimpangan_DDL').val(),
                Tahun: $('#Tahun_DDL_Deviaton').val()
            }
            $.ajax({
                type: "POST",
                url: "ShowAddAbleDeviation",
                data: JSON.stringify(dto),
                dataType: 'json',
                contentType: 'application/json; charset=utf-8',
                success: function (data) {
                    var table = $('#tblDeviation').DataTable({
                        "pageLength": 5,
                        "lengthChange": true,
                        "searching": false,
                        "data": JSON.parse(data),
                        "select": true,
                        "scrollCollapse": true,
                        "destroy": true,
                        "columns": [
                            {
                                "data": null,
                                "defaultContent": "<input class='selected' type='checkbox'/>"
                            },
                            { "data": "DEVIATION_NO" },
                            { "data": "NAMA_PELOPOR" },
                            { "data": "DEVIATION_CATEGORY" },
                            { "data": "DEVIATION_TYPE" },
                            { "data": "KET_CATEGORY" }
                        ],
                        "order": [[1, 'asc']],
                        "columndefs": [
                            {
                                "targets": 0,
                                "classname": "select-checkbox",
                                "width": "1%"
                            },
                            {
                                "targets": 1,
                                "classname": "text-center",
                                "width": "5%"
                            },
                            {
                                "targets": 2,
                                "classname": "text-center",
                                "width": "6%"
                            },
                            {
                                "targets": 3,
                                "classname": "text-center",
                                "width": "6%"
                            },
                            {
                                "targets": 4,
                                "classname": "text-center",
                                "width": "4%"
                            },
                            {
                                "targets": 5,
                                "classname": "text-left",
                                "width": "15%"
                            }
                        ]
                    });
                }
            });
        });

        $('#btn_Search_CCC').click(function () {

            dto = {
                Option: 2,
                NoCapa: QSNoCAPA,
                JenisKeluhan: $('#JenisKeluhan_DDL').val(),
                Tahun: $('#Tahun_DDL').val(),
                Plant: $('#Plant_DDL').val(),
                Kategori: $('#JenisKategori_DDL').val()
            }

            $.ajax({
                type: "POST",
                url: "ShowAddAbleDeviation",
                data: JSON.stringify(dto),
                dataType: 'json',
                contentType: 'application/json; charset=utf-8',
                success: function (result) {
                    var table = $('#Tbl_CCC').DataTable({
                        "pageLength": 5,
                        "lengthChange": true,
                        "searching": false,
                        "data": JSON.parse(result),
                        "select": true,
                        "bDestroy": true,
                        "scrollCollapse": true,
                        "columns": [
                            {
                                "data": null,
                                "defaultContent": "<input class='selected' type='checkbox' name='type' onchange=''>"
                            },
                            { "data": "No_CCC" },
                            { "data": "Jenis_Keluhan" },
                            { "data": "Nama_Produk" },
                            { "data": "No_batch" },
                            { "data": "Keluhan_Plgn" },
                            { "data": "PlantSC" },
                            { "data": "Kategori" },
                            { "data": "StatusCCC" }
                        ],
                        "order": [[1, 'asc']],
                        "columnDefs": [
                            {
                                "targets": 0,
                                "className": "text-center",
                                "width": "1%"
                            },
                            {
                                "targets": 1,
                                "className": "text-center",
                                "width": "5%"
                            },
                            {
                                "targets": 2,
                                "className": "text-center",
                                "width": "6%"
                            },
                            {
                                "targets": 3,
                                "className": "text-center",
                                "width": "6%"
                            },
                            {
                                "targets": 4,
                                "className": "text-center",
                                "width": "4%"
                            },
                            {
                                "targets": 5,
                                "className": "text-left",
                                "width": "15%"
                            }
                        ]
                    });
                }
            });
        });
        $('#btn_Search_CAPA').click(function () {

            dto = {
                Option: 5,
                NoCapa: QSNoCAPA,
                Kode: $('#Kode_CAPA').val(),
                Tahun: $('#Tahun_DDL_CAPA').val(),
                Departemen: $('#DepartemenPelapor_CAPA').val(),
                Kategori: $('#Kategori_CAPA').val(),
                Lokasi: $('#Lokasi_CAPA').val()
            }
            console.log($('#Lokasi_CAPA').val());
            console.log($('#Kategori_CAPA').val());
            console.log($('#DepartemenPelapor_CAPA').val());
            console.log($('#Tahun_DDL_CAPA').val());
            console.log($('#Kode_CAPA').val());
            console.log(QSNoCAPA);
            $.ajax({
                type: "POST",
                url: "ShowAddAbleDeviation",
                data: JSON.stringify(dto),
                dataType: 'json',
                contentType: 'application/json; charset=utf-8',
                success: function (result) {
                    console.log(result);
                    var table = $('#tblCAPA').DataTable({
                        "pageLength": 5,
                        "lengthChange": true,
                        "searching": false,
                        "data": JSON.parse(result),
                        "select": true,
                        "bDestroy": true,
                        "scrollCollapse": true,
                        "columns": [
                            {
                                "data": null,
                                "defaultContent": "<input class='selected' type='checkbox' name='type' onchange=''>"
                            },
                            { "data": "NO_CAPA" },
                            { "data": "PIC_CAPA" },
                            { "data": "AREA_PIC" },
                            { "data": "LOKASI_CAPA" },
                            { "data": "KATEGORI_CAPA" },
                            { "data": "KODE_CAPA" },
                            { "data": "DESKRIPSI_MASALAH" }
                        ],
                        "order": [[1, 'asc']],
                        "columnDefs": [
                            {
                                "targets": 0,
                                "className": "text-center",
                                "width": "1%"
                            },
                            {
                                "targets": 1,
                                "className": "text-center",
                                "width": "5%"
                            },
                            {
                                "targets": 2,
                                "className": "text-center",
                                "width": "6%"
                            },
                            {
                                "targets": 3,
                                "className": "text-center",
                                "width": "6%"
                            },
                            {
                                "targets": 4,
                                "className": "text-center",
                                "width": "4%"
                            },
                            {
                                "targets": 5,
                                "className": "text-left",
                                "width": "15%"
                            }
                        ]
                    });
                }
            });
        });
        //checkbox Deviation
        var data = [];
        $(document).on("click", "#Tbl_Deviation input[name='type'][class='selected']", function () {
            if ($(this).prop('checked') == true) {
                var columns = $(this).closest('tr').find('td:eq(1)').text();
                var id = {};
                id.PENYIMPANGAN_ID = columns;
                data.push(id);
            }
            else {
                var columns = $(this).closest('tr').find('td:eq(1)').text();
                data.splice(data.findIndex(e => e.PENYIMPANGAN_ID === columns), 1);
            }
            $('#PenyimpanganNumber').val(JSON.stringify(data));
            if (data.length == 0)
                $('#TxtDeviation').val("Tidak ada data terkait yang dipilih.");
            else {
                $('#PenyimpanganTerkait').val("Yes");
                $('#TxtDeviation').val(data.length + " Data telah dipilih.");
            }

        });

        $(document).on("click", "#Tbl_CCC input[name='type'][class='selected']", function () {
            if ($(this).prop('checked') == true) {
                var columns = $(this).closest('tr').find('td:eq(1)').text();
                var id = {};
                id.PENYIMPANGAN_ID = columns;
                data.push(id);
            }
            else {
                var columns = $(this).closest('tr').find('td:eq(1)').text();
                data.splice(data.findIndex(e => e.PENYIMPANGAN_ID === columns), 1);
            }
            $('#PenyimpanganNumber').val(JSON.stringify(data));
            if (data.length == 0)
                $('#TxtCCC').val("Tidak ada data terkait yang dipilih.");
            else {
                $('#KeluhanTerkait').val("Yes");
                $('#TxtCCC').val(data.length + " Data telah dipilih.");
            }
        });



    });
    function getTableRow() {
        var DeptList = new Array();
        $("#Tbl_Departemen tr").each(function () {
            var row = $(this);
            var data = {};
            data.Departemen = row.find("td").eq(0).html();
            DeptList.push(data);
            $("#myObj").val(JSON.stringify(DeptList));
        });
    }
    function TahunDDL() {
        var years = new Date().getFullYear();
        for (var i = years; i >= 2018; i--) {
            $('#Tahun_DDL').append(new Option(i, i));
            $('#Tahun_DDL_Deviaton').append(new Option(i, i));
            $('#Tahun_DDL_CAPA').append(new Option(i, i));
        }
    }

    function clearHidden() {
        $('#Linked_Oracle').prop('hidden', true);
        $('#Linked_CCC').prop('hidden', true);
        $('#Linked_Deviation').prop('hidden', true);
        $('#Linked_Renew').prop('hidden', true);
    }

    function getDDL() {
        $.ajax({
            url: 'GetKoordinatorDDL',
            type: 'post',
            data: JSON.stringify({
                Option: 1,
                SP: "[dbo].[SP_SHOW_DDL]"
            }),
            async: false,
            dataType: 'json',
            contentType: 'application/json; charset=utf-8',
            success: function (data) {
                $('#Trigger_CAPA').empty();
                $('#Kategori_DDL').empty();
                $('#Lokasi_DDL').empty();
                $('#Lokasi_CAPA').empty();
                $('#Trigger_CAPA').empty();
               /* $('#Trigger_CAPA').append('<option disabled selected hidden class="dropdown-header">Pilih</option>');*/
                $('#Kategori_DDL').append('<option disabled selected hidden class="dropdown-header">Pilih</option>');
                $('#Lokasi_DDL').append('<option disabled selected hidden class="dropdown-header">Pilih</option>');
                $('#Lokasi_CAPA').append('<option disabled selected hidden class="dropdown-header">Pilih</option>');
                $.each(JSON.parse(data), function (key, entry) {
                    if (entry.DDL_TYPE == 'TRIGGER') {
                       $('#Trigger_CAPA').append($('<option></option>').attr('value', entry.DDL_CODE).text(entry.DDL_DESCRIPTION));
                    }
                    if (entry.DDL_TYPE == 'KATEGORI') {
                        $('#KategoriPenyimpangan_DDL').append($('<option></option>').attr('value', entry.DDL_CODE).text(entry.DDL_DESCRIPTION));
                        $('#Kategori_CAPA').append($('<option></option>').attr('value', entry.DDL_DESCRIPTION).text(entry.DDL_DESCRIPTION));
                    }
                    if (entry.DDL_TYPE == 'LOKASI') {
                        $('#Lokasi_DDL').append($('<option></option>').attr('value', entry.DDL_CODE).text(entry.DDL_DESCRIPTION));
                        $('#Lokasi_CAPA').append($('<option></option>').attr('value', entry.DDL_DESCRIPTION).text(entry.DDL_DESCRIPTION));
                    }
                    $('#Kategori_DDL').select2();
                })
            },
            error: function (ex) {
                alert(JSON.stringify(ex));
            }
        });

        $.ajax({
            url: 'GetDepartments',
            type: 'post',
            async: false,
            dataType: 'json',
            data: JSON.stringify({
                Option: 21,
                SP: "[dbo].[SP_SHOW_DDL]"
            }),
            contentType: 'application/json; charset=utf-8',
            success: function (data) {
                $('#DepartemenPelapor_DDL').empty();
                $.each(JSON.parse(data), function (key, entry) {
                    $('#DepartemenPelapor_DDL').append($('<option></option>').attr('value', entry.Org_Group_Name).text(entry.Org_Group_Name));
                    $('#DepartemenPelapor_CAPA').append($('<option></option>').attr('value', entry.Org_Group_Name).text(entry.Org_Group_Name));

                })
            },
            error: function (ex) {
                alert(JSON.stringify(ex));
            }
        });

        $.ajax({
            url: 'GetKategoriPenyimpangan',
            type: 'post',
            async: false,
            dataType: 'json',
            data: JSON.stringify({
                Option: 5,
                SP: "[dbo].[SP_SHOW_DDL]"
            }),
            contentType: 'application/json; charset=utf-8',
            success: function (data) {
                $('#KategoriPenyimpangan_DDL').empty();
                //$('#KategoriPenyimpangan_DDL').append($('<option></option>').attr('value', '').text('Pilih'));
                $.each(JSON.parse(data), function (key, entry) {
                    $('#KategoriPenyimpangan_DDL').append($('<option></option>').attr('value', entry.DDL_CODE).text(entry.DDL_DESCRIPTION));

                })
                //$('#KategoriPenyimpangan_DDL').select2();
            },
            error: function (ex) {
                alert(JSON.stringify(ex));
            }
        });

        $.ajax({
            url: 'GetPlantCCC',
            type: 'post',
            async: false,
            dataType: 'json',
            data: JSON.stringify({
                Option: 6,
                SP: "[dbo].[SP_SHOW_DDL]"
            }),
            contentType: 'application/json; charset=utf-8',
            success: function (data) {
                $('#Plant_DDL').empty();
                $.each(JSON.parse(data), function (key, entry) {
                    $('#Plant_DDL').append($('<option></option>').attr('value', entry.PlantSC).text(entry.Plant));
                })
            },
            error: function (ex) {
                alert(JSON.stringify(ex));
            }
        });

        $.ajax({
            url: 'DynamicController?spname=[dbo].[SP_SHOW_DDL]',
            type: 'post',
            async: false,
            dataType: 'json',
            data: JSON.stringify({
                Model: {
                    Option: 18
                }
            }),
            contentType: 'application/json; charset=utf-8',
            success: function (data) {
                $('#Kode_CAPA').empty();
                $('#Kode_CAPA').append('<option disabled selected hidden class="dropdown-header">Pilih</option>');
                $.each(JSON.parse(data), function (key, entry) {
                    $('#Kode_CAPA').append($('<option></option>').attr('value', entry.Code).text(entry.Code_Desc));
                })
            },
            error: function (ex) {
                alert(JSON.stringify(ex));
            }
        });

        $.ajax({
            url: 'DynamicController?spname=[dbo].[SP_SHOW_DDL]',
            type: 'post',
            async: false,
            dataType: 'json',
            data: JSON.stringify({
                Model: {
                    Option: 18
                }
            }),
            contentType: 'application/json; charset=utf-8',
            success: function (data) {
                $('#Kode_CAPA').empty();
                $('#Kode_CAPA').append('<option disabled selected hidden class="dropdown-header">Pilih</option>');
                $.each(JSON.parse(data), function (key, entry) {
                    $('#Kode_CAPA').append($('<option></option>').attr('value', entry.Code).text(entry.Code_Desc));
                })
            },
            error: function (ex) {
                alert(JSON.stringify(ex));
            }
        });

        $.ajax({
            url: 'DynamicController?spname=[dbo].[SP_SHOW_ADDABLE_DEVIATION]',
            type: 'post',
            async: false,
            dataType: 'json',
            data: JSON.stringify({
                Model: {
                    Option: 6,
                    NoCAPA: QSNoCAPA
                }
            }),
            contentType: 'application/json; charset=utf-8',
            success: function (data) {
                var result = JSON.parse(data);
                if (result[0].TRIGGER_CAPA == "DEVIATION") {
                    $('#Linked_Deviation').prop('hidden', false);
                    $('#Lampiran').prop('hidden', true);
                    $('#Submit').prop('hidden', true);
                    GetPenyimpangan();
                } else if (result[0].TRIGGER_CAPA == "CCC") {
                    $('#Linked_CCC').prop('hidden', false);
                    $('#Lampiran').prop('hidden', true);
                    $('#Submit').prop('hidden', true);
                    GetPenyimpangan();
                } else if (result[0].TRIGGER_CAPA == "CAPA") {
                    $('#Linked_CAPA').prop('hidden', false);
                    $('#Lampiran').prop('hidden', true);
                    $('#Submit').prop('hidden', true);
                    GetPenyimpangan();
                }
                else {
                    $('#Lampiran').prop('hidden', false);
                    $('#Submit').prop('hidden', false);
                    GetLampiran();
                }
                $('#Trigger_CAPA').val(result[0].TRIGGER_CAPA);
                $('#Trigger_CAPA').select2();
                $('#Trigger_CAPA').attr("disabled", true);
            },
            error: function (ex) {
                alert(JSON.stringify(ex));
            }
        });
    }

    function GetPenyimpangan() {
        $('#List_Penyimpangan').prop("hidden", false);
        $.ajax({
            url: 'DynamicController?spname=[dbo].[SP_SHOW_DDL]',
            type: 'post',
            dataType: 'json',
            data: JSON.stringify({
                Model: {
                    Option: 22,
                    NO_CAPA: QSNoCAPA
                }
            }),
            contentType: 'application/json; charset=utf-8',
            success: function (data) {
                var table = $('#Tbl_Penyimpangan').DataTable({
                    "pageLength": 5,
                    "data": JSON.parse(data),
                    "lengthChange": true,
                    "paging": true,
                    "info": false,
                    "searching": false,
                    "select": true,
                    "bDestroy": true,
                    "scrollCollapse": true,
                    "columns": [
                        { "data": "RecordID" },
                        { "data": "PENYIMPANGAN_ID" },
                        {
                            "data": null,
                            "render": function (data, type, row, meta) {
                                return "<input type='button' class='btn btn-primary' onclick=DeletePenyimpangan(this) value='Delete'style='background-color:red;'/>";
                            }
                        }

                    ],
                    "columnDefs": [
                        {
                            "targets": [0],
                            "visible": false,
                            "searchable": false
                        },
                    ],
                });
            },
            error: function (ex) {
                alert(JSON.stringify(ex));
            }
        });
    }


    function GetLampiran() {
        $('#List_Lampiran').prop("hidden", false);
        $.ajax({
            url: 'DynamicController?spname=[dbo].[SP_SHOW_DDL]',
            type: 'post',
            dataType: 'json',
            data: JSON.stringify({
                Model: {
                    Option: 23,
                    NO_CAPA: QSNoCAPA,
                    Tahapan: "Lampiran Koordinator"
                }
            }),
            contentType: 'application/json; charset=utf-8',
            success: function (data) {
                var table = $('#Tbl_Lampiran').DataTable({
                    "pageLength": 5,
                    "data": JSON.parse(data),
                    "lengthChange": true,
                    "paging": true,
                    "info": false,
                    "searching": false,
                    "select": true,
                    "bDestroy": true,
                    "scrollCollapse": true,
                    "columns": [
                        {"data":"RecordID"},
                        {
                            "data": "FILE_NAME",
                            "render": function (nTd, sData, oData, iRow, iCol) {

                                return '<a href = "' + oData.FILE_PATH + '" >' + oData.FILE_NAME + '</a >';
                            }
                        },
                        {
                            "data": null,
                            "render": function (data, type, row, meta) {
                                return "<input type='button' class='btn btn-primary' onclick=DeleteLampiran(this) value='Delete'style='background-color:red;'/>";
                            }
                        }
                    ],
                    "columnDefs": [
                        {
                            "targets": [0],
                            "visible": false,
                            "searchable": false
                        },
                    ],
                });
            },
            error: function (ex) {
                alert(JSON.stringify(ex));
            }
        });
    }

    function DeleteLampiran(button) {
        Swal.fire({
            title: 'Are you sure?',
            text: "You won't be able to revert this!",
            type: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Delete!',
            reverseButtons: true
        }).then((result) => {
            if (result.value) {
                var row = $(button).closest("TR");
                var data = $('#Tbl_Lampiran').DataTable().row(row).data();
                var id = data['RecordID'];
                var path = data['FILE_PATH'];
                var formData = {
                    "IDAttachment": id,
                    "Updater": path
                };

                $.ajax({
                    url: "DeleteAttachment",
                    type: "post",
                    dataType: "json",
                    data: JSON.stringify(formData),
                    contentType: "application/json;charset=utf-8",
                    success: function (data) {

                        Swal.fire({
                            title: "Deleted!",
                            text: 'Lampiran Berhasil Di Hapus!',
                            icon: "success",
                            showConfirmButton: false,
                            timer: 1000,
                        })
                        GetLampiran();
                    },
                    error: function (errormessage) {
                    }
                });
            }
        })
    }

    function DeletePenyimpangan(button) {
        Swal.fire({
            title: 'Are you sure?',
            text: "You won't be able to revert this!",
            type: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Delete!',
            reverseButtons: true
        }).then((result) => {
            if (result.value) {
                var row = $(button).closest("TR");
                var data = $('#Tbl_Penyimpangan').DataTable().row(row).data();
                var id = data['RecordID'];
                var dictlist = {
                    Option: 24,
                    RecID: id
                }
                var dto1 = {
                    Model: dictlist
                }
                $.ajax({
                    url: "DynamicController?spname=[dbo].[SP_SHOW_DDL]",
                    type: "post",
                    dataType: "json",
                    data: JSON.stringify(dto1),
                    contentType: "application/json;charset=utf-8",
                    success: function (data) {
                        Swal.fire({
                            title: "Deleted!",
                            text: 'Penyimpangan Berhasil Di Hapus!',
                            icon: "success",
                            showConfirmButton: false,
                            timer: 1000,
                        })
                        GetPenyimpangan();
                    },
                    error: function (errormessage) {
                    }
                });
            }
        })
    }

    function AddDepartemen() {
        var departemen = $('#Departemen_DDL').val();
        if (departemen.length > 0) {
            dto = {
                Departemen: departemen
            }

            $.ajax({
                url: 'AddDepartments',
                type: 'post',
                dataType: 'json',
                data: JSON.stringify(dto),
                contentType: 'application/json; charset=utf-8',
                success: function (data) {
                    $('#List_Departemen').prop('hidden', false);
                    $("#Tbl_Departemen").empty();
                    $("#AreaPIC_DDL").empty().prop('disabled', false);
                    $("#PIC_DDL").empty().prop('disabled', false);
                    $('#AreaPIC_DDL').append($('<option></option>').attr('value', '').text('*Select Area PIC*'));
                    $.each(data, function (key, entry) {
                        $('#Tbl_Departemen').append($('<tr><td>' + entry.Departemen + '</td><td><button type="button" class="form-control-sm delete">Delete</button></td></tr>'));
                        $('#AreaPIC_DDL').append($('<option></option>').attr('value', entry.Departemen).text(entry.Departemen));
                        getTableRow();
                    })
                    //$('#AreaPIC_DDL').append($('<option></option>').attr('value', 'Others').text('Others'));
                    $('#AreaPIC_DDL').select2();
                },
                error: function (ex) {
                    alert(JSON.stringify(ex));
                }
            });
        } else {
            Swal.fire({
                title: "Warning!",
                text: 'Mohon dipilih kembali.',
                icon: "warning",
                showConfirmButton: false,
                timer: 1000,
            })
        }
    }


    function DeleteDepartemen() {
        $(document).on("click", "#Tbl_Departemen button.delete", function () {
            $('#VendorDiv').prop('hidden', true);
            var columns = $(this).closest('tr').find('td:eq(0)').text();
            dto = {
                Departemen: columns
            }
            $.ajax({
                url: 'DeleteDepartments',
                type: 'post',
                dataType: 'json',
                data: JSON.stringify(dto),
                contentType: 'application/json; charset=utf-8',
                success: function (data) {
                    var Count = data.length;
                    $("#Tbl_Departemen").empty();
                    $("#AreaPIC_DDL").empty().prop('disabled', false);
                    $("#PIC_DDL").empty().prop('disabled', false);
                    $('#AreaPIC_DDL').append($('<option></option>').attr('value', '').text('*Select Area PIC*'));
                    if (Count > 0) {
                        $.each(data, function (key, entry) {
                            $('#Tbl_Departemen').append($('<tr><td>' + entry.Departemen + '</td><td><button type="button" class="form-control-sm delete">Delete</button></td></tr>'));
                            $('#AreaPIC_DDL').append($('<option></option>').attr('value', entry.Departemen).text(entry.Departemen));
                            getTableRow();
                        })
                    } else {
                        $('#List_Departemen').prop('hidden', true);
                    }
                    //$('#AreaPIC_DDL').append($('<option></option>').attr('value', 'Others').text('Others'));
                    $('#AreaPIC_DDL').select2();
                },
                error: function (ex) {
                    alert(JSON.stringify(ex));
                }
            });
        });
    }

    function Submit() {
        var formData = new FormData();
        var totalFiles = document.getElementById("TxtFileInput").files.length;
        if (totalFiles == 0 || totalFiles == undefined) {
            Swal.fire({
                title: "Error!",
                text: 'Silahkan Memilih File Attachment terlebih dahulu!',
                icon: "error",
                showConfirmButton: false,
                timer: 1000,
            })
        }
        else {
            for (var i = 0; i < totalFiles; i++) {
                var file = document.getElementById("TxtFileInput").files[i];
                formData.append("TxtFileInput", file);
                //formData.append("NoCAPA", $('#txtNoCAPA').val());
            }
            $.ajax({
                url: "InsertAttachment?NoCapa=" + QSNoCAPA + "&spname=SP_Insert_Penyimpangan&Creator=" + loginusernik+"",
                type: "post",
                data: formData,
                dataType: 'json',
                contentType: false,
                processData: false,
                success: function (data) {
                    var result = JSON.parse(data);
                    if (result[0].Validate == "Invalid") {
                        Swal.fire({
                            title: "Error!",
                            text: 'File sudah ada!',
                            icon: "error",
                            showConfirmButton: false,
                            timer: 1000,
                        })
                    }
                    else {
                        Swal.fire({
                            title: "Success!",
                            text: 'Upload Berhasil!',
                            icon: "success",
                            showConfirmButton: false,
                            timer: 1000,
                        })
                        GetLampiran();
                    }
                },
                error: function (errormessage) {
                    $('#divLoading').attr("hidden", true);
                }

            });
        }

    }




</script>