@using B7_CAPA_Online.Models
@model DALModel
@{
    ViewBag.Title = "CreateCAPA";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var DepartemenObj = Request["data"];
}

<link href="~/Content/Scripts/plugins/datatables/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="~/Content/Scripts/plugins/sweetalert2/dist/sweetalert2.min.css" rel="stylesheet" />
<link href="~/Content/Scripts/plugins/bootstrap-tagsinput/css/bootstrap-tagsinput.css" rel="stylesheet" />


<style>
    @@media (min-width: 768px) {
        .modal-xl {
            width: 900%;
            max-width: 1300px;
        }
    }
</style>

<div class="content-body" id="myDiv">

    <!--Modal-->
    <div class="modal fade" id="link_Deviation" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Filter</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group col-md-6">
                            <label for="TxtTahunDeviation" class="col-form-label">Tahun:</label>
                            <div class="input-group">
                                <select class="form-control select2" name="TahunDeviation" id="Tahun_DDL" required>
                                </select>
                            </div>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="TxtDepartemenDeviation" class="col-form-label">Departemen Pelapor:</label>
                            <div class="input-group ">
                                <select class="form-control select2" id="DepartemenPelapor_DDL" required>
                                </select>
                            </div>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="TxtKategoriDeviation" class="col-form-label">Kategori Penyimpangan:</label>
                            <div class="input-group">
                                <select class="form-control select2" id="KategoriPenyimpangan_DDL" required>
                                </select>
                            </div>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="TxtJenisPenyimpangan" class="col-form-label">Jenis Penyimpangan:</label>
                            <div class="input-group">
                                <select class="form-control select2" id="JenisPenyimpangan_DDL" required>
                                    <option value="Yes">Terencana</option>
                                    <option value="No">Tidak Terencana</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group col-md-6">
                            <button type="button" class="btn btn-primary" id="btn_Search_Deviation">Search</button>
                        </div>
                        <table class="table table-hover table-bordered zero-configuration" id="Tbl_Deviation" style="color: black" hidden>
                            <thead>
                                <tr>
                                    <th>Action</th>
                                    <th>No Penyimpangan</th>
                                    <th>Nama Pelapor</th>
                                    <th>Kategori Penyimpangan</th>
                                    <th>Jenis Penyimpangan</th>
                                    <th>Deskripsi Singkat</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                </tr>
                            </tbody>
                        </table>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="link_CCC" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Filter</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group col-md-6">
                            <label for="TxtTahunCCC" class="col-form-label">Tahun:</label>
                            <div class="input-group">
                                <select class="form-control select2 TahunCCC" name="TahunCCC" id="Tahun_DDL" required>
                                </select>
                            </div>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="TxtPlantCCC" class="col-form-label">Plant:</label>
                            <div class="input-group ">
                                <select class="form-control select2" id="Plant_DDL" required>
                                </select>
                            </div>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="TxtKategoriCCC" class="col-form-label">Jenis Kategori:</label>
                            <div class="input-group">
                                <select class="form-control select2" id="JenisKategori_DDL" required>
                                    <option value="JUSTIFIED">Justified</option>
                                    <option value="UNJUSTIFIED">Unjustified</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="TxtKeluhanCCC" class="col-form-label">Jenis Keluhan:</label>
                            <div class="input-group">
                                <select class="form-control select2" id="JenisKeluhan_DDL" required>
                                    <option value="Quality">Quality</option>
                                    <option value="Health">Health</option>
                                    <option value="Promotion">Promotion</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group col-md-6">
                            <button type="button" class="btn btn-primary" id="btn_Search_CCC">Search</button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover table-bordered zero-configuration" id="Tbl_CCC" style="color: black" hidden>
                                <thead>
                                    <tr>
                                        <th>Action</th>
                                        <th>No CCC</th>
                                        @*<th>Nama Pelanggan</th>*@
                                        <th>Jenis Kategori</th>
                                        <th>Jenis Keluhan</th>
                                        <th>Deskripsi Singkat</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="link_NoCAPATerkait" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Filter</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group col-md-6">
                            <label for="TahunCAPA" class="col-form-label">Tahun:</label>
                            <div class="input-group">
                                <select class="form-control select2 TahunCAPA" name="TahunCAPA" id="TahunCAPA" required>
                                </select>
                            </div>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="LokasiCAPA_DDL" class="col-form-label">Lokasi</label>
                            <div class="input-group ">
                                <select class="form-control select2" id="LokasiCAPA_DDL" required>
                                </select>
                            </div>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="KategoriCAPA_DDL" class="col-form-label">Jenis Kategori:</label>
                            <div class="input-group">
                                <select class="form-control select2" id="KategoriCAPA_DDL" required>
                                </select>
                            </div>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="AreaPICCAPA_DDL" class="col-form-label">Departemen PIC</label>
                            <div class="input-group">
                                <select class="form-control select2" id="AreaPICCAPA_DDL" required>
                                </select>
                            </div>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="KodeCAPA_DDL" class="col-form-label">Kode CAPA</label>
                            <div class="input-group">
                                <select class="form-control select2" id="KodeCAPA_DDL" required>
                                </select>
                            </div>
                        </div>
                        <div class="form-group col-md-6">
                            <button type="button" class="btn btn-primary" id="btn_Search_NoCAPATerkait">Search</button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover table-bordered zero-configuration" id="Tbl_NoCAPATerkait" style="color: black" hidden>
                                <thead>
                                    <tr>
                                        <th>Action</th>
                                        <th>No CAPA</th>
                                        <th>Nama PIC</th>
                                        <th>Jenis Kategori</th>
                                        <th>Area PIC</th>
                                        <th>Lokasi</th>
                                        <th>Deskripsi Singkat</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="link_Vendor" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Filter</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <label for="recipient-name" class="col-form-label">Tahun:</label>
                            <input type="text" class="form-control" id="TxtTahunRenew">
                        </div>
                        <div class="form-group">
                            <label for="message-text" class="col-form-label">Departemen:</label>
                            <input class="form-control" id="TxtDepartemenRenew">
                        </div>
                        <div class="form-group">
                            <label for="message-text" class="col-form-label">Kategori Penyimpangan:</label>
                            <input class="form-control" id="TxtKategoriRenew">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Filter</button>
                </div>
            </div>
        </div>
    </div>

    <div class="row page-titles mx-0">
        <div class="col p-md-0">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="javascript:void(0)">Dashboard</a></li>
                <li class="breadcrumb-item active"><a href="javascript:void(0)">Home</a></li>
            </ol>
        </div>
    </div>
    <!-- row -->

    <div class="container-fluid" id="myContainer">
        <div class="row">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title">Koordinator</h4>
                        <form>
                            <div class="row">
                                <div class="form-group mb-2 col-sm-3">
                                    <label class="m-t-20">Tanggal</label>
                                    <input type="text" id="date-format" class="form-control form-control-sm" value="@DateTime.Now.ToString("MM/dd/yyyy HH:mm")" readonly disabled>
                                </div>
                                <div class="form-group mb-2 col-sm-3">
                                    <label class="m-t-40">Requestor</label>
                                    <input class="form-control form-control-sm" type="text" id="input_Requestor" value="" readonly disabled>
                                </div>
                                <div class="form-group mb-2 col-sm-3">
                                    <label class="m-t-20">Nomor CAPA</label>
                                    <input class="form-control form-control-sm" type="text" id="input_NoCAPA" value="@Request.QueryString["NoCAPA"]" readonly disabled />
                                    <input class="form-control form-control-sm" type="text" id="input_REG_ID" value="@Request.QueryString["REG"]" hidden />
                                    <input class="form-control form-control-sm" type="text" id="input_NIK" value="@Request.RequestContext.HttpContext.Session["NIK"]" hidden disabled />
                                </div>
                                <div class="form-group mb-2 col-sm-3">
                                    <label class="m-t-40">Departemen</label>
                                    <input class="form-control form-control-sm" type="text" id="input_Departemen" value="@Request.RequestContext.HttpContext.Session["Departemen"]" readonly disabled>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                @if (!string.IsNullOrEmpty(Request.QueryString["NoCAPA"]))
                {
                    <div class="card">
                        <div class="card-body">
                            <!--form class="needs-validation"-->
                            @using (Html.BeginForm("InsertCAPA", "Koordinator", FormMethod.Post, new { enctype = "multipart/form-data", @class = "needs-validation" }))
                            {
                                <div class="row form-group-sm mb-2">
                                    <div class="col-md-6">
                                        <label class="m-t-20">Trigger CAPA<span style="color: red">*</span></label>
                                        <select class="form-control form-control-sm" id="Trigger_CAPA" name="TriggerCAPA" required disabled>
                                        </select>
                                        @Html.HiddenFor(m => m.TriggerCAPA)
                                    </div>
                                </div>
                                @*<div class="row form-group" id="Linked_Deviation" hidden>
                                        <div class="col-md-6">
                                            <label class="m-t-20">Penyimpangan Terkait</label>
                                            <div class="input-group mb-3">
                                                <div class="input-group-prepend">
                                                    <button class="btn btn-outline-dark" type="button" data-toggle="modal" data-target="#link_Deviation">Browse</button>
                                                </div>
                                                <input type="text" class="form-control" id="TxtDeviation" name="TxtDeviation">
                                                <input type="text" class="form-control" name="PenyimpanganTerkait" id="PenyimpanganTerkait" value="" hidden>
                                                @Html.HiddenFor(m => m.PenyimpanganTerkait)
                                            </div>
                                        </div>
                                    </div>*@
                                <div class="row form-group-sm" id="List_Penyimpangan">
                                    <div class="col-md-6">
                                        <label class="m-t-20">List Penyimpangan</label>
                                        <div class="table-responsive">
                                            <table class="table table-hover table-bordered zero-configuration" id="Tbl_Penyimpangan" style="color: black">
                                                <thead>
                                                    <tr>
                                                        <th>Penyimpangan</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                @*<div class="row form-group" id="Linked_CCC" hidden>
                                        <div class="col-md-6">
                                            <label class="m-t-40">Keluhan Pelanggan Terkait</label>
                                            <div class="input-group mb-3">
                                                <div class="input-group-prepend">
                                                    <button class="btn btn-outline-dark" type="button" data-toggle="modal" data-target="#link_CCC">Browse</button>
                                                </div>
                                                <input type="text" class="form-control" id="TxtCCC" name="TxtCCC">
                                                <input type="text" class="form-control" name="KeluhanTerkait" id="KeluhanTerkait" value="" hidden>
                                                @Html.HiddenFor(m => m.KeluhanTerkait)
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row form-group" id="Linked_Oracle" hidden>
                                        <div class="col-md-6">
                                            <label class="m-t-20">No. QC terkait ATB/PMTMS/FKM</label>
                                            <div class="input-group mb-3">
                                                <div class="input-group-prepend">
                                                    <button class="btn btn-outline-dark" type="button" data-toggle="modal" data-target="#link_Oracle">Browse</button>
                                                </div>
                                                <input type="text" class="form-control" id="TxtOracle" name="TxtOracle">
                                                <input type="text" class="form-control" name="No_QC_Terkait" value="" hidden>
                                                @Html.HiddenFor(m => m.No_QC_Terkait)
                                            </div>
                                        </div>
                                    </div>*@
                                @*<div class="row form-group-sm mb-2">
                                        <div class="col-md-6">
                                            <label class="m-t-20">Lampiran Terkait</label>
                                            <div class="input-group mb-3">
                                                <div class="custom-file">
                                                    <input id="TxtFileInput" type="file" name="LampiranTerkait" class="custom-file-input" multiple required>
                                                    @Html.HiddenFor(m => m.LampiranTerkait)
                                                    <label class="custom-file-label">Choose File</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>*@
                                <div class="row form-group-sm" id="List_Lampiran">
                                    <div class="col-md-6">
                                        <label class="m-t-20">List Lampiran</label>
                                        <div class="table-responsive">
                                            <table class="table table-hover table-bordered zero-configuration" id="Tbl_Lampiran" style="color: black">
                                                <thead>
                                                    <tr>
                                                        <th>Lampiran</th>
                                                    </tr>
                                                </thead>
                                                <tbody style="color: black">
                                                    <tr>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <div class="row form-group-sm mb-2">
                                    <div class="col-md-6">
                                        <label class="m-t-20">Kategori</label>
                                        <select class="form-control form-control-sm" id="Kategori_DDL" name="KategoriCAPA" required disabled>
                                            <option>Option 1</option>
                                            <option>Option 2</option>
                                            <option>Option 3</option>
                                        </select>
                                        @Html.HiddenFor(m => m.KategoriCAPA)
                                    </div>
                                </div>
                                <div class="row form-group-sm mb-2">
                                    <div class="col-md-6">
                                        <label class="m-t-20">Kode</label>
                                        <select class="form-control form-control-sm" id="Kode_DDL" name="KodeCAPA" disabled>
                                            <option>Option 1</option>
                                            <option>Option 2</option>
                                            <option>Option 3</option>
                                        </select>
                                        @Html.HiddenFor(m => m.KodeCAPA)
                                    </div>
                                </div>
                                <div class="row form-group-sm mb-2" id="Div_KataKunci" hidden>
                                    <div class="col-md-6">
                                        <label class="m-t-20">Kata Kunci</label>
                                        <input class="form-control " id="TxtKataKunci" name="KataKunci" readonly />
                                        @Html.HiddenFor(m => m.KataKunci)
                                    </div>
                                </div>
                                <div class="row form-group-sm">
                                    <div class="col-md-6">
                                        <label class="m-t-20">Deskripsi Masalah<span style="color: red">*</span></label>
                                        <textarea id="TxtDeskripsi" type="text" class="form-control" name="Deskripsi" placeholder="Deskripsi" rows="3" required readonly></textarea>
                                        @Html.HiddenFor(m => m.Deskripsi)
                                    </div>
                                </div>
                                <div class="row form-group-sm mb-2">
                                    <div class="col-md-6">
                                        <label class="m-t-20">Lokasi</label>
                                        <select class="form-control form-control-sm" id="Lokasi_DDL" name="Lokasi" required disabled>
                                            <option>Option 1</option>
                                            <option>Option 2</option>
                                            <option>Option 3</option>
                                        </select>
                                        @Html.HiddenFor(m => m.Lokasi)
                                    </div>
                                    <div class="col-md-4">
                                        <label class="m-t-20">Area PIC CAPA<span style="color: red">*</span></label>
                                        <select class="form-control" id="AreaPIC_DDL" name="AreaPIC" required disabled>
                                        </select>
                                        @Html.HiddenFor(m => m.AreaPIC)
                                    </div>
                                </div>
                                <div class="row form-group-sm mb-4">
                                    <div class="col-md-6">
                                        <label class="m-t-20">Bagian terkait yang perlu melakukan tindakan perbaikan dan atau pencegahan<span style="color: red">*</span></label>
                                        <div class="input-group" hidden>
                                            <select class="form-control select2" id="Departemen_DDL">
                                            </select>
                                            <div class="input-group-append" style="padding-left:10px">
                                                <button class="btn btn-outline-dark rounded btn-sm" type="button" id="btn_Add">Add</button>
                                            </div>
                                        </div>
                                        <label>@ViewBag.Message</label>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="m-t-20">PIC CAPA<span style="color: red">*</span></label>
                                        <select class="form-control form-control-sm" id="PIC_DDL" name="PIC_CAPA" required disabled>
                                        </select>
                                        @Html.HiddenFor(m => m.PIC_CAPA)
                                    </div>
                                </div>
                                <div class="row form-group-sm" id="List_Departemen">
                                    <div class="col-md-6">
                                        <label class="m-t-20">List Departemen Terkait</label>
                                        <div class="table-responsive">
                                            <table class="table table-hover table-bordered zero-configuration" id="Table_Departemen" style="color:black">
                                                <thead>
                                                    <tr>
                                                        <th>Departemen</th>

                                                    </tr>
                                                </thead>
                                                <tbody id="Tbl_Departemen">
                                                    <tr>
                                                    </tr>
                                                </tbody>
                                            </table>
                                            @Html.HiddenFor(m => m.DepartemenCollection, new { id = "myObj", value = "" })
                                            @Html.HiddenFor(m => m.PenyimpanganCollection, new { id = "PenyimpanganNumber", value = "" })
                                        </div>
                                    </div>
                                    <div class="col-md-4" id="VendorDiv">
                                        <label class="m-t-40">Email</label>
                                        <div class="input-group mb-3">
                                            <input type="text" class="form-control" id="TxtEmailVendor" name="Email" readonly>
                                            <input class="form-control form-control-sm" type="text" id="input_Requestors" name="Create_By" value="@Request.RequestContext.HttpContext.Session["NIK"]" hidden>
                                            @Html.HiddenFor(m => m.Email)
                                            @Html.HiddenFor(m => m.Create_By)
                                        </div>
                                    </div>
                                </div>



                                @*<div class="row form-group-sm">
                                        <div class="col-md-6">
                                            <label class="m-t-20">Nama Vendor</label>
                                            <input class="form-control form-control-sm" type="text" id="input_Vendor">
                                            <label class="m-t-40">Nama Personil</label>
                                            <input class="form-control form-control-sm" type="text" id="input_Personil">
                                            <label class="m-t-40">Email</label>
                                            <input class="form-control form-control-sm" type="email" id="input_Email">
                                        </div>
                                    </div>*@
                                @*<div class="row form-group-sm">
                                        <div class="col-md-6 mt-1">
                                            <input class="btn mb-1 btn-primary" type="submit" id="btn_Submit" onclick="validateInput();" />
                                        </div>
                                    </div>*@
                            }
                            <!--/form-->
                        </div>
                        @Html.Partial("TindakanPerbaikanPV")
                        @Html.Partial("TindakanPencegahanPV")
                        @Html.Partial("KajianResikoPV")
                    </div>
                }
                else
                {
                    <div class="card">
                        <div class="card-body">
                            <!--form class="needs-validation"-->
                            @using (Html.BeginForm("InsertCAPA", "Koordinator", FormMethod.Post, new { enctype = "multipart/form-data", id = "SubmitData" }))
                            {
                                @Html.AntiForgeryToken()
                                <div class="row form-group-sm mb-2">
                                    <div class="col-md-6">
                                        <label class="m-t-20">Trigger CAPA<span style="color: red">*</span></label>
                                        <select class="form-control form-control-sm" id="Trigger_CAPA" name="TriggerCAPA" required="" oninvalid="this.setCustomValidity('The TriggerCAPA field is required.')" oninput="this.setCustomValidity('')">
                                        </select>
                                        @Html.HiddenFor(m => m.TriggerCAPA)
                                    </div>
                                </div>
                                <div class="row form-group" id="Linked_Deviation" hidden>
                                    <div class="col-md-6">
                                        <label class="m-t-20">Penyimpangan Terkait</label>
                                        <div class="input-group mb-3">
                                            <div class="input-group-prepend">
                                                <button class="btn btn-outline-dark" type="button" id="btn_Deviation" data-toggle="modal" data-target="#link_Deviation">Browse</button>
                                            </div>
                                            <input type="text" class="form-control" id="TxtDeviation" name="TxtDeviation">
                                            <input type="text" class="form-control" name="PenyimpanganTerkait" id="PenyimpanganTerkait" value="" hidden>
                                            @Html.HiddenFor(m => m.PenyimpanganTerkait)
                                        </div>
                                    </div>
                                </div>
                                <div class="row form-group" id="Linked_CCC" hidden>
                                    <div class="col-md-6">
                                        <label class="m-t-40">Keluhan Pelanggan Terkait</label>
                                        <div class="input-group mb-3">
                                            <div class="input-group-prepend">
                                                <button class="btn btn-outline-dark" type="button" data-toggle="modal" data-target="#link_CCC">Browse</button>
                                            </div>
                                            <input type="text" class="form-control" id="TxtCCC" name="TxtCCC">
                                            <input type="text" class="form-control" name="KeluhanTerkait" id="KeluhanTerkait" value="" hidden>
                                            @Html.HiddenFor(m => m.KeluhanTerkait)
                                        </div>
                                    </div>
                                </div>
                                @*<div class="row form-group" id="Linked_Oracle" hidden>
                                        <div class="col-md-6">
                                            <label class="m-t-20">No. QC terkait ATB/PMTMS/FKM</label>
                                            <div class="input-group mb-3">
                                                <div class="input-group-prepend">
                                                    <button class="btn btn-outline-dark" type="button" data-toggle="modal" data-target="#link_Oracle">Browse</button>
                                                </div>
                                                <input type="text" class="form-control" id="TxtOracle" name="TxtOracle">
                                                <input type="text" class="form-control" name="No_QC_Terkait" value="" hidden>
                                                @Html.HiddenFor(m => m.No_QC_Terkait)
                                            </div>
                                        </div>
                                    </div>*@
                                <div class="row form-group" id="Linked_NoCAPATerkait" hidden>
                                    <div class="col-md-6">
                                        <label class="m-t-20">No CAPA Terkait</label>
                                        <div class="input-group mb-3">
                                            <div class="input-group-prepend">
                                                <button class="btn btn-outline-dark" type="button" id="btn_NoCAPATerkait" data-toggle="modal" data-target="#link_NoCAPATerkait">Browse</button>
                                            </div>
                                            <input type="text" class="form-control" id="TxtNoCAPATerkait" name="TxtNoCAPATerkait">
                                            <input type="text" class="form-control" name="No_CAPA_Terkait" id="No_CAPA_Terkait" value="" hidden>
                                            @Html.HiddenFor(m => m.No_CAPA_Terkait)
                                        </div>
                                    </div>
                                </div>
                                <div class="row form-group-sm mb-2">
                                    <div class="col-md-6">
                                        <table class="table table-hover table-bordered zero-configuration" id="Table_Penyimpangan" style="color:black;">
                                            <thead>
                                                <tr>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="row form-group-sm mb-2 attachments">
                                    <div class="col-md-6">
                                        <label class="m-t-20">Lampiran Terkait</label>
                                        <div class="input-group mb-3">
                                            <div class="custom-file">
                                                <input id="TxtFileInput" type="file" name="LampiranTerkait" class="custom-file-input" multiple>
                                                @Html.HiddenFor(m => m.LampiranTerkait)
                                                <label id="TxtLampiranCount" class="custom-file-label"></label>
                                            </div>
                                            @*<div class="input-group-append" style="padding-left:10px">
                                                    <button class="btn btn-outline-dark rounded btn-sm" type="button" id="btn_AddFile">Add</button>
                                                </div>*@
                                        </div>
                                    </div>
                                </div>
                                <div class="row form-group-sm mb-2" id="Table_File">
                                    <div class="col-md-6">
                                        <table class="table table-hover table-bordered zero-configuration" id="Tbl_File" style="color:black;">
                                            <thead>
                                                <tr>
                                                    <th>Filename</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tb_File">
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="row form-group-sm mb-2">
                                    <div class="col-md-6">
                                        <label class="m-t-20">Kategori</label>
                                        <select class="form-control form-control-sm" id="Kategori_DDL" name="KategoriCAPA">
                                            <option>Option 1</option>
                                            <option>Option 2</option>
                                            <option>Option 3</option>
                                        </select>
                                        @Html.HiddenFor(m => m.KategoriCAPA)
                                    </div>
                                </div>
                                <div class="row form-group-sm mb-2">
                                    <div class="col-md-6">
                                        <label class="m-t-20">Kode</label>
                                        <select class="form-control form-control-sm" id="Kode_DDL" name="KodeCAPA">
                                            <option>Option 1</option>
                                            <option>Option 2</option>
                                            <option>Option 3</option>
                                        </select>
                                        @Html.HiddenFor(m => m.KodeCAPA)
                                    </div>
                                </div>
                                <div class="row form-group-sm mb-2" id="Div_KataKunci" hidden>
                                    <div class="col-md-6">
                                        <label class="m-t-20">Kata Kunci</label>
                                        <input class="form-control tags" id="TxtKataKunci" name="KataKunci" data-role="tagsinput" />
                                        @Html.HiddenFor(m => m.KataKunci)
                                    </div>
                                </div>
                                <div class="row form-group-sm">
                                    <div class="col-md-6">
                                        <label class="m-t-20">Deskripsi Masalah<span style="color: red">*</span></label>
                                        <textarea id="TxtDeskripsi" type="text" class="form-control" name="Deskripsi" placeholder="Deskripsi" rows="3"></textarea>
                                        @Html.HiddenFor(m => m.Deskripsi)
                                    </div>
                                </div>
                                <div class="row form-group-sm mb-2">
                                    <div class="col-md-6">
                                        <label class="m-t-20">Lokasi</label>
                                        <select class="form-control form-control-sm" id="Lokasi_DDL" name="Lokasi">
                                            <option>Option 1</option>
                                            <option>Option 2</option>
                                            <option>Option 3</option>
                                        </select>
                                        @Html.HiddenFor(m => m.Lokasi)
                                        @*@Html.HiddenFor(m => m.LokasiDesc)*@
                                    </div>
                                    <div class="col-md-4">
                                        <label class="m-t-20">Area PIC CAPA<span style="color: red">*</span></label>
                                        <select class="form-control" id="AreaPIC_DDL" name="AreaPIC">
                                        </select>
                                        @Html.HiddenFor(m => m.AreaPIC)
                                    </div>
                                </div>
                                <div class="row form-group-sm mb-4">
                                    <div class="col-md-6">
                                        <label class="m-t-20">Bagian terkait yang perlu melakukan tindakan perbaikan dan atau pencegahan<span style="color: red">*</span></label>
                                        <div class="input-group">
                                            <select class="form-control" id="Departemen_DDL">
                                            </select>
                                            <div class="input-group-append" style="padding-left:10px">
                                                <button class="btn btn-outline-dark rounded btn-sm" type="button" id="btn_Add">Add</button>
                                            </div>
                                        </div>
                                        <label>@ViewBag.Message</label>
                                    </div>
                                    <div class="col-md-4" id="div_PICCAPA">
                                        <label class="m-t-20">PIC CAPA<span style="color: red">*</span></label>
                                        <select class="form-control form-control-sm" id="PIC_DDL" name="PIC_CAPA">
                                        </select>
                                        @*<div class="input-group">
                                                <select class="form-control form-control-sm" id="PIC_DDL" name="PIC_CAPA">
                                                </select>
                                                <div class="input-group-append" style="padding-left:10px">
                                                    <button class="btn btn-outline-dark rounded btn-sm" type="button" id="btn_AddPIC">Add</button>
                                                </div>
                                            </div>*@
                                        <input class="form-control form-control-sm" type="text" id="PIC_ID" name="PIC_ID" hidden />
                                        <input class="form-control form-control-sm" type="text" id="PIC_Dept" name="PIC_Dept" hidden />
                                        @Html.HiddenFor(m => m.PIC_CAPA)
                                        @Html.HiddenFor(m => m.PIC_ID)

                                    </div>
                                </div>
                                <div class="row form-group-sm" id="List_Departemen" hidden>
                                    <div class="col-md-6">
                                        <label class="m-t-20">List Departemen Terkait</label>
                                        <div class="table">
                                            <table class="table table-hover table-bordered zero-configuration" id="Table_Departemen" style="color:black">
                                                <thead>
                                                    <tr>
                                                        <th>Departemen</th>
                                                        <th>Action</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="Tbl_Departemen">
                                                </tbody>
                                            </table>
                                            @Html.HiddenFor(m => m.DepartemenCollection, new { id = "myObj", value = "" })
                                            @Html.HiddenFor(m => m.PenyimpanganCollection, new { id = "PenyimpanganNumber", value = "" })
                                        </div>
                                    </div>

                                    <div class="col-md-6" id="div_ListPIC" hidden>
                                        <label class="m-t-20">List PIC</label>
                                        <div class="table">
                                            <table class="table table-hover table-bordered zero-configuration" id="Table_PIC" style="color:black">
                                                <thead>
                                                    <tr>
                                                        <th>PIC</th>
                                                        <th>Departemen</th>
                                                        <th hidden>NIK</th>
                                                        <th hidden>Email</th>
                                                        <th hidden>Action</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="Tbl_PIC">
                                                </tbody>
                                            </table>
                                            @Html.HiddenFor(m => m.PICCollection, new { id = "myObj2", value = "" })
                                        </div>
                                    </div>

                                    <div class="col-md-4" id="VendorDiv" hidden>
                                        <label class="m-t-40">Email</label>
                                        <div class="input-group mb-3">
                                            <input type="text" class="form-control" id="TxtEmailVendor" name="Email" readonly>
                                            <input class="form-control form-control-sm" type="text" id="input_Requestors" name="Create_By" value="@Request.RequestContext.HttpContext.Session["NIK"]" hidden>
                                            @Html.HiddenFor(m => m.Email)
                                            @Html.HiddenFor(m => m.Create_By)
                                        </div>
                                        <label class="m-t-40">PIC</label>
                                        <div class="input-group mb-3">
                                            <input type="text" class="form-control" id="TxtPICVendor" name="TxtPICVendor" readonly>
                                            <input type="text" class="form-control" id="TxtVendorSupID" name="UserSupVDRID" hidden>
                                            @Html.HiddenFor(m => m.UserSupVDRID)
                                        </div>
                                    </div>
                                </div>

                                @*<div class="row form-group-sm">
                                            <div class="col-md-6">
                                                <label class="m-t-20">Nama Vendor</label>
                                                <input class="form-control form-control-sm" type="text" id="input_Vendor">
                                                <label class="m-t-40">Nama Personil</label>
                                                <input class="form-control form-control-sm" type="text" id="input_Personil">
                                                <label class="m-t-40">Email</label>
                                                <input class="form-control form-control-sm" type="email" id="input_Email">
                                            </div>
                                    </div>*@
                                <div class="row form-group-sm">
                                    <div class="col-md-6 mt-1">
                                        <input class="btn mb-1 btn-primary" type="button" id="btn_Submit" value="Submit" style="background-color:green;" />
                                    </div>
                                    @*<div class="col-md-6 mt-1">
                                            <input class="btn mb-1 btn-primary" type="button" id="btn_Submits" value="Submits" />
                                        </div>*@
                                </div>
                            }
                            <!--/form-->
                        </div>
                    </div>
                }

            </div>
        </div>

    </div>
    <!-- #/ container -->
</div>


@*JQuery Library*@
@*<script src="../plugins/bootstrap-material-datetimepicker/js/bootstrap-material-datetimepicker.js"></script>
    <script src="../plugins/bootstrap-datepicker/bootstrap-datepicker.min.js"></script>*@
<script src="~/Content/Scripts/plugins/sweetalert2/dist/sweetalert2.min.js" defer></script>
<script src="~/Content/Scripts/plugins/datatables/jquery.dataTables.min.js" defer></script>
<script src="~/Content/Scripts/plugins/jquery/jquery.min.js"></script>
<script src="~/Content/Scripts/plugins/bootstrap-tagsinput/js/bootstrap-tagsinput.min.js" defer></script>
<script src="~/Content/Scripts/plugins/block-ui/jquery.blockUI.js" defer></script>

<script>

    var formData = new FormData();
    isDetail = false;
    $(document).ready(function () {
        $('.tags').tagsinput({
            maxTags: 4
        });
        GetDepartements();
        GetDeptNoCAPATerkait();

        //variable data untuk menampung data deviation dan ccc
        var data = [];
        $('#input_Requestor').val('@Request.RequestContext.HttpContext.Session["FullName"]');

        $('#AreaPIC_DDL').select2();
        $('#Kode_DDL').select2();
        $('#PIC_DDL').select2();
        $('#Departemen_DDL').select2().append();

        $('#Trigger_CAPA').change(function () {
            $('.attachments').prop("hidden", false);
            clearHidden();
            $('#Table_Penyimpangan').prop("hidden", true);
            data = [];
            $('#Tbl_Deviation tbody').empty();
            $('#Tbl_CCC tbody').empty();
            $('#Tbl_NoCAPATerkait tbody').empty();
            $('#TxtDeviation').val("");
            $('#TxtCCC').val("");
            $('#TxtNoCAPATerkait').val("");
            $('#Table_File').prop("hidden", false);
            $('#TxtFileInput').val("");
            $('#tb_File').empty();
            $('#TxtLampiranCount').text("");
            //formData.forEach(function (val, key, fD) {
            //    console.log(key);
            //});
            //UpdateLampiran();

            if ($('#Trigger_CAPA').val() == "CAPA") {
                $('#Linked_NoCAPATerkait').prop('hidden', false);
                $('.attachments').prop("hidden", true);
                $('#Table_File').prop("hidden", true);
            } else if ($('#Trigger_CAPA').val() == "CCC") {
                $('#Linked_CCC').prop('hidden', false);
                $('.attachments').prop("hidden", true);
                $('#Table_File').prop("hidden", true);
            } else if ($('#Trigger_CAPA').val() == "DEVIATION"){
                $('#Linked_Deviation').prop('hidden', false);
                $('.attachments').prop("hidden", true);
                $('#Table_File').prop("hidden", true);
            }
        });

        $('#btn_Add').click(function () {        
            AddDepartemen();
            resetPIC();
            $('#VendorDiv').prop('hidden', true);
        });

        //$('#btn_AddPIC').click(function () {
        //    AddPIC();
        //    $('#VendorDiv').prop('hidden', true);
        //});

        //Ketika dropdownlist lokasi dipilih akan ngeload departemen berdasarkan lokasi yang dipilih.
        var arr = [];
        //$('#Lokasi_DDL').change(function () {
        //    var Location;

        //    if ($('#Lokasi_DDL').val() == 'CKR') {
        //        Location = 'Cikarang';
        //    } else if ($('#Lokasi_DDL').val() == 'HOF') {
        //        Location = 'Head Office';
        //    } else if ($('#Lokasi_DDL').val() == 'ALL') {
        //        Location = 'Pulogadung,Cikarang';
        //    } else {
        //        Location = 'Pulogadung';
        //    }

        //    dto = {
        //        Option: 3,
        //        Departemen: $('#AreaPIC_DDL').val(),
        //        Lokasi: Location,
        //        SP: "[dbo].[SP_SHOW_DDL]"
        //    }

        //    $.ajax({
        //        url: 'GetDepartments',
        //        type: 'post',
        //        dataType: 'json',
        //        data: JSON.stringify({
        //            Option: 2,
        //            Lokasi: $('#Lokasi_DDL').val().toString(),
        //            SP: "[dbo].[SP_SHOW_DDL]"
        //        }),
        //        contentType: 'application/json; charset=utf-8',
        //        success: function (data) {
        //            console.log(data);
        //            resetTable(function _callback() {
        //                $('#Departemen_DDL').empty();
        //                $('#Departemen_DDL').append('<option disabled selected hidden class="dropdown-header">*Pilih*</option>');
        //                $.each(JSON.parse(data), function (key, entry) {
        //                    $('#Departemen_DDL').append($('<option></option>').attr('value', entry.SubDeptCode).text(entry.Dept));
        //                    $('#DepartemenPelapor_DDL').append($('<option></option>').attr('value', entry.Dept).text(entry.Dept));

        //                })
        //                $('#Departemen_DDL').append($('<option></option>').attr('value', 'Others').text('Others'));
        //                $('#Departemen_DDL').select2();
        //            });

        //        },
        //        error: function (ex) {
        //            alert(JSON.stringify(ex));
        //        }
        //    });
        //});

        //Ketika dropdownlist departemen dipilih akan ngeload PIC CAPA berdasarkan area yang dipilih.
        $('#AreaPIC_DDL').change(function () {
            //console.log($('#AreaPIC_DDL').val());
            var Location;
            $('#VendorDiv').prop('hidden', true);

            if ($('#Lokasi_DDL').val() == 'CKR') {
                Location = 'Cikarang';
            } else if ($('#Lokasi_DDL').val() == 'HOF') {
                Location = 'Head Office';
            } else if ($('#Lokasi_DDL').val() == 'ALL') {
                Location = 'Pulogadung,Cikarang';
            } else {
                Location = 'Pulogadung';
            }

            GetPIC(0);
            //_callback();
        });

        //Browse button Deviation
        $('#btn_Deviation').click(function () {
            GetDeptPenyimpangan();
        });

        //Browse button No CAPA Terkait
        $('#link_NoCAPATerkait').click(function () {

        });

        // Button search isi lampiran Deviation yang menyimpang.
        $('#btn_Search_Deviation').click(function () {
            $('#Tbl_Deviation').prop("hidden", false);
            //data = [];
            dto = {
                Option: 4,
                Departemen: $('#DepartemenPelapor_DDL').val(),
                Kategori: $('#KategoriPenyimpangan_DDL').val(),
                JenisPenyimpangan: $('#JenisPenyimpangan_DDL').val(),
                Tahun: $('#Tahun_DDL').val(),
                SP: "[dbo].[SP_SHOW_DDL]"
            }

            $.ajax({
                type: "POST",
                url: "GetPenyimpangan",
                data: JSON.stringify(dto),
                dataType: 'json',
                contentType: 'application/json; charset=utf-8',
                success: function (data) {
                    var table = $('#Tbl_Deviation').DataTable({
                        "pageLength": 5,
                        "paging": false,
                        "info" : false,
                        "lengthChange": true,
                        "searching": false,
                        "data": JSON.parse(data),
                        "select": true,
                        "bDestroy": true,
                        "scrollCollapse": true,
                        "columns": [
                            {
                                "data": null,
                                "defaultContent": "<input class='selected' type='checkbox' name='type' onchange=''>"
                            },
                            { "data": "DEVIATION_NO" },
                            { "data": "NAMA_PELOPOR" },
                            { "data": "DEVIATION_CATEGORY" },
                            { "data": "DEVIATION_TYPE" },
                            { "data": "KET_CATEGORY" }
                        ],
                        "order": [[1, 'asc']],
                        "columnDefs": [
                            {
                                "targets": 0,
                                "className": "text-center",
                                "width": "1%"
                            },
                            {
                                "targets": 1,
                                "className": "text-center",
                                "width": "5%"
                            },
                            {
                                "targets": 2,
                                "className": "text-center",
                                "width": "6%"
                            },
                            {
                                "targets": 3,
                                "className": "text-center",
                                "width": "6%"
                            },
                            {
                                "targets": 4,
                                "className": "text-center",
                                "width": "4%"
                            },
                            {
                                "targets": 5,
                                "className": "text-left",
                                "width": "15%"
                            }
                        ]
                    });
                }
            });
        });

        // Button search isi lampiran Deviation yang menyimpang.
        $('#btn_Search_NoCAPATerkait').click(function () {
            $('#Tbl_NoCAPATerkait').prop("hidden", false);
            //data = [];
            dto = {
                Option: 20,
                Departemen: $('#AreaPICCAPA_DDL').val(),
                Kategori: $('#KategoriCAPA_DDL').val(),
                Lokasi: $('#LokasiCAPA_DDL').val(),
                Tahun: $('#TahunCAPA').val(),
                KodeCAPA : $('#KodeCAPA_DDL').val(),
                SP: "[dbo].[SP_SHOW_DDL]"
            }

            $.ajax({
                type: "POST",
                url: "GetPenyimpangan",
                data: JSON.stringify(dto),
                dataType: 'json',
                contentType: 'application/json; charset=utf-8',
                success: function (data) {
                    var table = $('#Tbl_NoCAPATerkait').DataTable({
                        "pageLength": 5,
                        "paging": false,
                        "info": false,
                        "lengthChange": true,
                        "searching": false,
                        "data": JSON.parse(data),
                        "select": true,
                        "bDestroy": true,
                        "scrollCollapse": true,
                        "columns": [
                            {
                                "data": null,
                                "defaultContent": "<input class='selected' type='checkbox' name='type' onchange=''>"
                            },
                            { "data": "NO_CAPA" },
                            { "data": "PIC_CAPA" },
                            { "data": "KATEGORI_CAPA" },
                            { "data": "AREA_PIC" },
                            { "data": "LOKASI_CAPA" },
                            { "data": "DESKRIPSI_MASALAH" }
                        ],
                        "order": [[1, 'asc']],
                        "columnDefs": [
                            {
                                "targets": 0,
                                "className": "text-center",
                                "width": "1%"
                            },
                            {
                                "targets": 1,
                                "className": "text-center",
                                "width": "5%"
                            },
                            {
                                "targets": 2,
                                "className": "text-center",
                                "width": "6%"
                            },
                            {
                                "targets": 3,
                                "className": "text-center",
                                "width": "6%"
                            },
                            {
                                "targets": 4,
                                "className": "text-center",
                                "width": "4%"
                            },
                            {
                                "targets": 5,
                                "className": "text-left",
                                "width": "5%"
                            },
                            {
                                "targets": 6,
                                "className": "text-left",
                                "width": "15%"
                            }
                        ]
                    });
                }
            });
        });

        // Button search untuk menampilkan CCC yang menyimpang.
        $('#btn_Search_CCC').click(function () {
            $('#Tbl_CCC').prop("hidden", false);
            //data = [];
            dto = {
                Option: 7,
                Plant: $('#Plant_DDL').val(),
                Kategori: $('#JenisKategori_DDL').val(),
                JenisKeluhan: $('#JenisKeluhan_DDL').val(),
                Tahun: $('#Tahun_DDL').val(),
                SP: "[dbo].[SP_SHOW_DDL]"
            }

            $.ajax({
                type: "POST",
                url: "GetPenyimpangan",
                data: JSON.stringify(dto),
                dataType: 'json',
                contentType: 'application/json; charset=utf-8',
                success: function (result) {
                    var table = $('#Tbl_CCC').DataTable({
                        "pageLength": 5,
                        "lengthChange": true,
                        "searching": false,
                        "data": JSON.parse(result),
                        "select": true,
                        "bDestroy": true,
                        "scrollCollapse": true,
                        "columns": [
                            {
                                "data": null,
                                "defaultContent": "<input class='selected' type='checkbox' name='type' onchange=''>"
                            },
                            { "data": "No_CCC" },
                            //{ "data": "Nama_Plgn" },
                            { "data": "Kategori" },
                            { "data": "Keluhan_Plgn" },
                            { "data": "StatusCCC" }
                        ],
                        "order": [[1, 'asc']],
                        "columnDefs": [
                            {
                                "targets": 0,
                                "className": "text-center",
                                "width": "1%"
                            },
                            {
                                "targets": 1,
                                "className": "text-center",
                                "width": "5%"
                            },
                            //{
                            //    "targets": 2,
                            //    "className": "text-center",
                            //    "width": "6%"
                            //},
                            {
                                "targets": 2,
                                "className": "text-center",
                                "width": "6%"
                            },
                            {
                                "targets": 3,
                                "className": "text-center",
                                "width": "4%"
                            },
                            {
                                "targets": 4,
                                "className": "text-left",
                                "width": "15%"
                            }
                        ]
                    });
                }
            });
        });

        //Trigger Change untuk menampilkan kolom input KataKunci ketika milih Lain-Lain di dropdownlist Kode_DLL
        $('#Kode_DDL').change(function () {
            $('#Div_KataKunci').prop("hidden", true);
            if ($('#Kode_DDL').val() == "CODE012") {
                $('#Div_KataKunci').prop("hidden", false);
            }
        });

        //checkbox Deviation
        $(document).on("click", "#Tbl_Deviation input[name='type'][class='selected']", function () {
            if ($(this).prop('checked') == true) {
                var columns = $(this).closest('tr');
                var id = {};
                id.PENYIMPANGAN_ID = columns.find('td:eq(1)').text();
                id.NAMA_PELAPOR = columns.find('td:eq(2)').text();;
                id.JENIS_KATEGORI = columns.find('td:eq(3)').text();;
                id.JENIS_PENYIMPANGAN = columns.find('td:eq(4)').text();;
                id.DESKRIPSI = columns.find('td:eq(5)').text();;
                data.push(id);
            }
            else {
                var columns = $(this).closest('tr').find('td:eq(1)').text();
                data.splice(data.findIndex(e => e.PENYIMPANGAN_ID === columns), 1);
            }
            $('#PenyimpanganNumber').val(JSON.stringify(data));
            if (data.length == 0)
                $('#TxtDeviation').val("Tidak ada data terkait yang dipilih.");
            else {
                $('#PenyimpanganTerkait').val("Yes");
                $('#TxtDeviation').val(data.length + " Data telah dipilih.");
            }
            $('#Table_Penyimpangan').prop("hidden", false);
            $('#Table_Penyimpangan').DataTable({
                "pageLength": 5,
                "paging": false,
                "info": false,
                "lengthChange": true,
                "searching": false,
                "data": data,
                "select": true,
                "bDestroy": true,
                "scrollCollapse": true,
                "columns": [
                    {
                        "data": "PENYIMPANGAN_ID",
                        "title": "No Penyimpangan"
                    },
                    {
                        "data": "NAMA_PELAPOR",
                        "title": "Nama Pelapor"
                    },
                    {
                        "data": "JENIS_KATEGORI",
                        "title": "Jenis Kategori"
                    },
                    {
                        "data": "JENIS_PENYIMPANGAN",
                        "title": "Jenis Penyimpangan"
                    },
                    {
                        "data": "DESKRIPSI",
                        "title": "Deskripsi Singkat"
                    }
                ],
                "order": [[1, 'asc']]
            });

        });

        //checkbox CCC
        $(document).on("click", "#Tbl_CCC input[name='type'][class='selected']", function () {
            if ($(this).prop('checked') == true) {
                var columns = $(this).closest('tr');
                var id = {};
                id.PENYIMPANGAN_ID = columns.find('td:eq(1)').text();
                id.NAMA_PELANGGAN = columns.find('td:eq(2)').text();
                id.JENIS_KATEGORI = columns.find('td:eq(3)').text();
                id.JENIS_KELUHAN = columns.find('td:eq(4)').text();
                id.DESKRIPSI = columns.find('td:eq(5)').text();
                data.push(id);
            }
            else {
                var columns = $(this).closest('tr').find('td:eq(1)').text();
                data.splice(data.findIndex(e => e.PENYIMPANGAN_ID === columns), 1);
            }
            $('#PenyimpanganNumber').val(JSON.stringify(data));
            if (data.length == 0)
                $('#TxtCCC').val("Tidak ada data terkait yang dipilih.");
            else {
                $('#KeluhanTerkait').val("Yes");
                $('#TxtCCC').val(data.length + " Data telah dipilih.");
            }

            $('#Table_Penyimpangan').prop("hidden", false);
            $('#Table_Penyimpangan').DataTable({
                "pageLength": 5,
                "paging": false,
                "info": false,
                "lengthChange": true,
                "searching": false,
                "data": data,
                "select": true,
                "bDestroy": true,
                "scrollCollapse": true,
                "columns": [
                    {
                        "data": "PENYIMPANGAN_ID",
                        "title": "No CCC"
                    },
                    {
                        "data": "NAMA_PELANGGAN",
                        "title": "Nama Pelanggan"
                    },
                    {
                        "data": "JENIS_KATEGORI",
                        "title": "Jenis Kategori"
                    },
                    {
                        "data": "JENIS_KELUHAN",
                        "title": "Jenis Keluhan"
                    },
                    {
                        "data": "DESKRIPSI",
                        "title": "Deskripsi Singkat"
                    }
                ],
                "order": [[1, 'asc']]
            });
        });

        // CAPA Terkait
        $(document).on("click", "#Tbl_NoCAPATerkait input[name='type'][class='selected']", function () {
            if ($(this).prop('checked') == true) {
                var columns = $(this).closest('tr');
                var id = {};
                id.PENYIMPANGAN_ID = columns.find('td:eq(1)').text();
                id.NAMA_PIC = columns.find('td:eq(2)').text();
                id.JENIS_KATEGORI = columns.find('td:eq(3)').text();
                id.AREA_PIC = columns.find('td:eq(4)').text();
                id.LOKASI = columns.find('td:eq(5)').text();
                id.DESKRIPSI = columns.find('td:eq(6)').text();
                data.push(id);
            }
            else {
                var columns = $(this).closest('tr').find('td:eq(1)').text();
                data.splice(data.findIndex(e => e.PENYIMPANGAN_ID === columns), 1);
            }
            $('#PenyimpanganNumber').val(JSON.stringify(data));
            if (data.length == 0)
                $('#TxtNoCAPATerkait').val("Tidak ada data terkait yang dipilih.");
            else {
                $('#No_CAPA_Terkait').val("Yes");
                $('#TxtNoCAPATerkait').val(data.length + " Data telah dipilih.");
            }

            $('#Table_Penyimpangan').prop("hidden", false);
            $('#Table_Penyimpangan').DataTable({
                "pageLength": 5,
                "paging": false,
                "info": false,
                "lengthChange": true,
                "searching": false,
                "data": data,
                "select": true,
                "bDestroy": true,
                "scrollCollapse": true,
                "columns": [
                    {
                        "data": "PENYIMPANGAN_ID",
                        "title": "No CAPA"
                    },
                    {
                        "data": "NAMA_PIC",
                        "title": "Nama PIC"
                    },
                    {
                        "data": "JENIS_KATEGORI",
                        "title": "Jenis Kategori"
                    },
                    {
                        "data": "AREA_PIC",
                        "title": "Area PIC"
                    },
                    {
                        "data": "LOKASI",
                        "title": "Lokasi"
                    },
                    {
                        "data": "DESKRIPSI",
                        "title": "Deskripsi Singkat"
                    }
                ],
                "order": [[1, 'asc']]
            });
            //console.log(data)
        });

        requestPage();

        $('#TxtFileInput').change(function () {
            $('#tb_File').empty();
            fileCount = this.files.length;
            var names = $.map(this.files, function (val) { return val.name; });
            //console.log(names);
            var teks = (fileCount != 0) ? (fileCount + " Lampiran telah dipilih.") : ("");
            $('#Table_File').prop("hidden", true);
            if (fileCount > 0) {
                $('#Table_File').prop("hidden", false);
                $.each(names, function (key, value) {
                    $('#tb_File').append('<tr><td>' + value + '</td><tr>')
                });
            }

            $('#TxtLampiranCount').text(teks);

            //$('#Tbl_File').DataTable({
            //    "searching": false,
            //    "paging": false,
            //    "info": false,
            //    "pageLength": 4,
            //    "lengthChange": true,
            //});
        })


        //$("#btn_AddFile").click(function () {
        //    var isValid = false;
        //    var fileCount = document.getElementById("TxtFileInput").files.length;
        //    if (fileCount > 0) {
        //        $.map(document.getElementById("TxtFileInput").files, function (val) {
        //            if (formData.getAll(val.name)[0] == undefined) {
        //                formData.append(val.name, val);
        //                $('#tb_File').append('<tr><td value='+ val.name +'>' + val.name + '</td><td><button type="button" class="deleteFile form-control-sm">Delete</button></td><tr>')
        //                //return val.name;
        //                //console.log(formData.getAll(val.name)[0].name)
        //                isValid = true;
        //            } else {
        //                Swal.fire(
        //                    'Warning!',
        //                    'File : ' + val.name + ' sudah pernah ditambahkan.',
        //                    'warning'
        //                );
        //                isValid = false;
        //                return false;
        //            }
        //        });

        //        if (isValid) {
        //            UpdateLampiran();
        //        }

        //        //document.getElementById("TxtFileInput").value = "";
        //        $('#TxtLampiranCount').text("");
        //        //$('#LampiranTerkait').val(formData);
        //        console.log($('#LampiranTerkait').val());
        //        console.log($('#TxtFileInput').val());
        //    }
        //});

        //$(document).on("click", "#tb_File button.deleteFile", function (e) {
        //    e.preventDefault();
        //    var temp = [];
        //    var columns = $(this).closest('tr').find('td');
        //    $.each(columns, function (i, item) {
        //        var obj = {};
        //        obj.name = item.innerHTML;
        //        temp.push(obj);
        //    });
        //    formData.delete(temp[0].name);
        //    columns.remove();

        //    UpdateLampiran();
        //    //$('#LampiranTerkait').val(formData);
        //});

        $("#btn_Submit").click(function () {
            var status = validateInput();
            if (status) {
                $.blockUI();
                return $('#SubmitData').submit();
            }
            //$('#SubmitData').submit();
        });

    });

    function validateInput() {
        var tableContent = (document.getElementById("Table_Departemen").rows.length > 1) ? ((document.getElementById("Table_Departemen").rows.length > 1) ? (true): (false)) : (false);
      

        var trigger = $("#Trigger_CAPA").val();

        var isAttachment = true;
        var labelChild = "";

        if (trigger == "DEVIATION" || trigger == "CCC" || trigger == "CAPA") {
            labelChild = (trigger == "DEVIATION") ? ('Penyimpangan Terkait') : ((trigger == 'CCC') ? ("Keluhan Pelanggan Terkait") : ("No CAPA Terkait"))
            isAttachment = false;
        }

        data = {
            TriggerCAPA: trigger,
            PenyimpanganCollection: !isAttachment ? ($('#PenyimpanganNumber').val()): ("-"),
            LampiranTerkait: isAttachment ? ($("#TxtFileInput").val()) : ("-"),
            Kategori: $("#Kategori_DDL").val(),
            Kode: $('#Kode_DDL').val(),
            Deskripsi: $("#TxtDeskripsi").val(),
            Lokasi: $("#Lokasi_DDL").val(),
            DepartemenTerkait: tableContent,
            AreaPIC: $("#AreaPIC_DDL").val(),
            PIC: tableContent//$("#PIC_DDL").val()
        }

        for (var key in data) {
            //console.log(data[key])
            if (data[key] === "" || data[key] === false || data[key] === null) {
                if (key === 'PenyimpanganCollection' && data['PenyimpanganCollection'] === "" && !isAttachment) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Maaf',
                        text: 'Mohon input ' + labelChild + ' wajib diisi!',
                        showConfirmButton: false,
                        timer: 2000

                    });
                    return false;
                    break;
                }
                Swal.fire({
                    icon: 'warning',
                    title: 'Maaf',
                    text: 'Mohon input ' + key + ' wajib diisi!',
                    showConfirmButton: false,
                    timer: 2000
                });
                return false;
                break;
            }
        }
        return true;
    }

    function clearHidden() {
        $('#Linked_NoCAPATerkait').prop('hidden', true);
        $('#Linked_CCC').prop('hidden', true);
        $('#Linked_Deviation').prop('hidden', true);
        $('#Linked_Renew').prop('hidden', true);
    }

    function getDDL() {
        $.ajax({
            url: 'GetKoordinatorDDL',
            type: 'post',
            data: JSON.stringify({
                Option: 1,
                SP: "[dbo].[SP_SHOW_DDL]"
            }),
            dataType: 'json',
            contentType: 'application/json; charset=utf-8',
            success: function (data) {
                $('#Trigger_CAPA').empty();
                $('#Kategori_DDL').empty();
                $('#Lokasi_DDL').empty();
                $('#Trigger_CAPA').empty();
                $('#Trigger_CAPA').append('<option disabled selected hidden class="dropdown-header">*Pilih*</option>');
                $('#Kategori_DDL').append('<option disabled selected hidden class="dropdown-header">*Pilih*</option>');
                $('#Lokasi_DDL').append('<option disabled selected hidden class="dropdown-header">*Pilih*</option>');
                $.each(JSON.parse(data), function (key, entry) {
                    if (entry.DDL_TYPE == 'TRIGGER') {
                        $('#Trigger_CAPA').append($('<option></option>').attr('value', entry.DDL_CODE).text(entry.DDL_DESCRIPTION));
                    }
                    if (entry.DDL_TYPE == 'KATEGORI') {
                        $('#Kategori_DDL').append($('<option></option>').attr('value', entry.DDL_CODE).text(entry.DDL_DESCRIPTION));
                        $('#KategoriCAPA_DDL').append($('<option></option>').attr('value', entry.DDL_CODE).text(entry.DDL_DESCRIPTION));
                    }
                    if (entry.DDL_TYPE == 'LOKASI') {
                        $('#Lokasi_DDL').append($('<option></option>').attr('value', entry.DDL_CODE).text(entry.DDL_DESCRIPTION));
                        $('#LokasiCAPA_DDL').append($('<option></option>').attr('value', entry.DDL_CODE).text(entry.DDL_DESCRIPTION));
                    }
                    $('#Trigger_CAPA').select2();
                    $('#Kategori_DDL').select2();
                    $('#Lokasi_DDL').select2();
                })
            },
            error: function (ex) {
                alert(JSON.stringify(ex));
            }
        });

        $.ajax({
            url: 'GetKategoriPenyimpangan',
            type: 'post',
            dataType: 'json',
            data: JSON.stringify({
                Option: 5,
                SP: "[dbo].[SP_SHOW_DDL]"
            }),
            contentType: 'application/json; charset=utf-8',
            success: function (data) {
                $('#KategoriPenyimpangan_DDL').empty();
                //$('#KategoriPenyimpangan_DDL').append($('<option></option>').attr('value', '').text('*Pilih*'));
                $.each(JSON.parse(data), function (key, entry) {
                    $('#KategoriPenyimpangan_DDL').append($('<option></option>').attr('value', entry.DDL_CODE).text(entry.DDL_DESCRIPTION));
                })
                //$('#KategoriPenyimpangan_DDL').select2();
            },
            error: function (ex) {
                alert(JSON.stringify(ex));
            }
        });

        $.ajax({
            url: 'GetPlantCCC',
            type: 'post',
            dataType: 'json',
            data: JSON.stringify({
                Option: 6,
                SP: "[dbo].[SP_SHOW_DDL]"
            }),
            contentType: 'application/json; charset=utf-8',
            success: function (data) {
                $('#Plant_DDL').empty();
                $.each(JSON.parse(data), function (key, entry) {
                    $('#Plant_DDL').append($('<option></option>').attr('value', entry.PlantSC).text(entry.Plant));
                })
            },
            error: function (ex) {
                alert(JSON.stringify(ex));
            }
        });

        $.ajax({
            url: 'DynamicController?spname=[dbo].[SP_SHOW_DDL]',
            type: 'post',
            dataType: 'json',
            data: JSON.stringify({
                Model: {
                    Option: 18
                }
            }),
            contentType: 'application/json; charset=utf-8',
            success: function (data) {
                $('#Kode_DDL').empty();
                $('#KodeCAPA_DDL').empty();
                $('#Kode_DDL').append('<option disabled selected hidden class="dropdown-header">*Pilih*</option>');
                $.each(JSON.parse(data), function (key, entry) {
                    $('#Kode_DDL').append($('<option></option>').attr('value', entry.Code).text(entry.Code_Desc));
                    $('#KodeCAPA_DDL').append($('<option></option>').attr('value', entry.Code).text(entry.Code_Desc));
                })
            },
            error: function (ex) {
                alert(JSON.stringify(ex));
            }
        });
        return "done";
    }

    function AddDepartemen() {
        var departemen = $('#Departemen_DDL :selected').text();
        if (departemen.length > 0 && departemen != "*Pilih*") {
            $('#div_ListPIC').prop('hidden', true);
            $("#Table_Departemen").DataTable().destroy();
            dto = {
                Departemen: departemen,
                SubDeptCode: $('#Departemen_DDL').val()
            }

            $.ajax({
                url: 'AddDepartments',
                type: 'post',
                dataType: 'json',
                data: JSON.stringify(dto),
                contentType: 'application/json; charset=utf-8',
                success: function (data) {
                    //console.log(data);
                    $("#Tbl_Departemen").empty();
                    $('#List_Departemen').prop('hidden', false);                                        
                    $("#AreaPIC_DDL").empty().prop('disabled', false);
                    $("#PIC_DDL").empty().prop('disabled', false);
                    $('#AreaPIC_DDL').append('<option disabled selected hidden class="dropdown-header">*Select Area PIC*</option>');
                    $.each(data, function (key, entry) {
                        $('#Tbl_Departemen').append($('<tr><td>' + entry.Departemen + '</td><td><button type="button" class="form-control-sm delete">Delete</button></td></tr>'));
                        $('#AreaPIC_DDL').append($('<option></option>').attr('value', entry.SubDeptCode).text(entry.Departemen));
                        getTableRow();
                    })
                    //$('#AreaPIC_DDL').append($('<option></option>').attr('value', 'Others').text('Others'));
                    $('#AreaPIC_DDL').select2();
                    $('#Table_Departemen').DataTable({
                        autoWidth: false,
                        pageLength: 5,
                        lengthChange: false,
                        searching: false
                    });
                },
                error: function (ex) {
                    alert(JSON.stringify(ex));
                }
            });
        } else {

            Swal.fire({
                type: 'warning',
                title: 'Maaf',
                text: 'Mohon dipilih kembali.!',
                showConfirmButton: false,
                timer: 2000
            });
        }
    }
    function GetPIC(Stat) {
        if ($('#AreaPIC_DDL').val() == 'Others') {
            dto = {
                Option: 12,
                Departemen: $('#AreaPIC_DDL').val(),
                //Lokasi: Location,
                SP: "[dbo].[SP_SHOW_DDL]"
            }
        } else {
            dto = {
                Option: 3,
                Departemen: $('#AreaPIC_DDL').val(),
                //Lokasi: Location,
                SP: "[dbo].[SP_SHOW_DDL]"
            }
        }
        const dept = ["TK", "QC", "WH", "PR"];
        if (Stat < 1)  {
            resetPIC();
            $('#div_PICCAPA').prop('hidden', false);
            $('#div_ListPIC').prop('hidden', true);
            $.ajax({
                url: 'GetSupervisors',
                type: 'post',
                data: JSON.stringify(dto),
                dataType: 'json',
                contentType: 'application/json; charset=utf-8',
                success: function (data) {
                    //console.log(data);
                    $('#PIC_DDL').empty();
                    $('#PIC_DDL').append('<option disabled selected hidden class="dropdown-header">*Pilih*</option>');
                    if ($('#AreaPIC_DDL').val() != 'Others') {
                        clearInputEmail();
                        if (dept.includes($('#AreaPIC_DDL').val())) {
                            $('#div_PICCAPA').prop('hidden', true);
                            AddPIC(data);
                        } else {
                            $.each(JSON.parse(data), function (key, entry) {
                                $('#PIC_DDL').append(new Option(entry.EmpName, entry.EmpName));
                            });

                            $('#PIC_DDL').change(function () {
                                var PIC_Name = $('#PIC_DDL').val();
                                $.each(JSON.parse(data), function (key, entry) {
                                    if (PIC_Name == entry.EmpName) {
                                        $('#PIC_Dept').val(entry.OrgGroupName);
                                        $('#TxtEmailVendor').val(entry.Email);
                                        $('#TxtPICVendor').val(entry.EmpName);
                                        $('#PIC_ID').val(entry.EmpID);
                                        return false;
                                    }
                                });
                                AddPIC(data);
                            });
                        }
                    } else {
                        $('#VendorDiv').prop('hidden', false);
                        clearInputEmail();

                        $.each(JSON.parse(data), function (key, entry) {
                            $('#PIC_DDL').append($('<option></option>').attr('value', entry.UserVDRName).text(entry.UserVDRName));
                        });

                        $('#PIC_DDL').change(function () {
                            var PIC_Name = $('#PIC_DDL').val();
                            $.each(JSON.parse(data), function (key, entry) {
                                if (PIC_Name == entry.UserVDRName) {
                                    //console.log(entry);
                                    $('#TxtEmailVendor').val(entry.email);
                                    $('#TxtPICVendor').val(entry.UserVDRName);
                                    $('#TxtVendorSupID').val(entry.SuperiorID);
                                    $('#PIC_ID').val(entry.UserID);
                                    return false;
                                }
                            });
                            AddPIC(data);
                        });
                    }
                    //if ($('#PIC_DDL').val() == null) {
                    //    $('#PIC_DDL').append($('<option></option>').attr('value', '').text('None'));
                    //}


                    $('#PIC_DDL').select2();

                },
                error: function (ex) {
                    alert(JSON.stringify(ex));
                }
            });
        }
    }
    function DeleteDepartemen() {
        $(document).on("click", "#Tbl_Departemen button.delete", function () {
            $('#VendorDiv').prop('hidden', true);
            var columns = $(this).closest('tr').find('td:eq(0)').text();
            var checkddl = false;
            var areaSDC;
            var selectedArea;
            var currentPIC = $('#PIC_DDL').val();


            if ($('#AreaPIC_DDL').text() != columns) {
                checkddl = true;
                selectedArea = $('#AreaPIC_DDL option:selected').text();
            }
            dto = {
                Departemen: columns
            }
            $.ajax({
                url: 'DeleteDepartments',
                type: 'post',
                dataType: 'json',
                data: JSON.stringify(dto),
                contentType: 'application/json; charset=utf-8',
                success: function (data) {
                    console.table(data);
                    var Count = data.length;
                    var checkgrouping = false;
                    $('#Table_Departemen').DataTable().clear().destroy();
                   
                    $("#AreaPIC_DDL").empty().prop('disabled', false);
                    $('#AreaPIC_DDL').append($('<option disabled></option>').attr('value', '').text('*Select Area PIC*'));
                    if (Count > 0) {
                        $.each(data, function (key, entry) {
                            $('#Tbl_Departemen').append($('<tr><td>' + entry.Departemen + '</td><td ><button type="button" class="form-control-sm delete">Delete</button></td></tr>'));
                            $('#AreaPIC_DDL').append($('<option></option>').attr('value', entry.SubDeptCode).text(entry.Departemen));
                            
                            getTableRow();
                            if (checkddl == true && entry.Departemen == selectedArea) {
                                areaSDC = entry.SubDeptCode;
                            }
                        })
                        $('#Table_Departemen').DataTable({
                            autoWidth: false,
                            pageLength: 5,
                            lengthChange: false,
                            searching: false
                        });
                    } 
                    if (checkddl == true) {
                        $('#AreaPIC_DDL').val(areaSDC);
                        GetPIC(1);
                    }
                    if (selectedArea == columns) {
                        $('#div_ListPIC').prop('hidden', true);
                        $("#PIC_DDL").empty();
                        GetPIC(0);
                    }
                    //$('#AreaPIC_DDL').append($('<option></option>').attr('value', 'Others').text('Others'));
                    $('#AreaPIC_DDL').select2();
                },
                error: function (ex) {
                    alert(JSON.stringify(ex));
                }
            });
        });
    }

    function renameKeys(args, newKeys) {
        let result;
        let arr = [];
        const destructArgs = JSON.parse(args).map( obj => {
            result = Object.keys(obj).map(key => {
                const newKey = newKeys[key] || key;
                return keyValues = { [newKey]: obj[key] };               
            });          
            arr.push(Object.assign({}, ...result));
        });     
        return arr;
    }

    function AddPIC(data) {
        var PIC = $('#PIC_DDL :selected').text();
        const dept = ["TK", "QC", "WH", "PR"];
        const renamedObj = renameKeys(data, { EmpID: "NIK", EmpName: "PIC" , OrgGroupName: "Departemen"})
        if (PIC.length > 0 && PIC != "*Pilih*" || dept.includes($('#AreaPIC_DDL').val())) {            
            if (dept.includes($('#AreaPIC_DDL').val())) {
                dto = renamedObj;
            }
            else {
                dto = [{
                    PIC: PIC,
                    NIK: $('#PIC_ID').val(),
                    Departemen: ($('#AreaPIC_DDL').val() != "Others") ? ($('#PIC_Dept').val()) : ('Others') ,
                    Email: $('#TxtEmailVendor').val()
                }]
            }

            //console.log(dto);
            $.ajax({
                url: 'AddPIC',
                type: 'post',
                dataType: 'json',
                data: JSON.stringify(dto),
                contentType: 'application/json; charset=utf-8',
                success: function (data) {
                    //console.log(data);
                    if ($('#AreaPIC_DDL').val() != "Others") {
                        $('#div_ListPIC').prop('hidden', false);
                    }                  
                    $('#Table_PIC').DataTable().destroy();
                    $("#Tbl_PIC").empty();
                    //$("#AreaPIC_DDL").empty().prop('disabled', false);
                    //$("#PIC_DDL").empty().prop('disabled', false);
                    //$('#AreaPIC_DDL').append('<option disabled selected hidden class="dropdown-header">*Select Area PIC*</option>');
                    $.each(data, function (key, entry) {
                        $('#Tbl_PIC').append($('<tr><td>' + entry.PIC + '</td><td>' + entry.Departemen + '</td><td hidden>' + entry.NIK + '</td><td hidden>' + entry.Email + '</td><td hidden><button type="button" class="form-control-sm delete">Delete</button></td></tr>'));
                        //$('#AreaPIC_DDL').append($('<option></option>').attr('value', entry.SubDeptCode).text(entry.Departemen));
                        getTableRow();
                    })
                    //$('#AreaPIC_DDL').append($('<option></option>').attr('value', 'Others').text('Others'));
                    //$('#AreaPIC_DDL').select2();
                    $('#Table_PIC').DataTable({
                        autoWidth: false,
                        pageLength: 5,
                        lengthChange: false,
                        searching: false
                    });
                },
                error: function (ex) {
                    alert(JSON.stringify(ex));
                }
            });
        } else {

            Swal.fire({
                icon: 'warning',
                title: 'Maaf',
                text: 'Mohon dipilih kembali.!',
                showConfirmButton: false,
                timer: 2000
            });
        }
    }

    function DeletePIC() {
        $(document).on("click", "#Tbl_PIC button.delete", function () {
            $('#VendorDiv').prop('hidden', true);
            var columns = $(this).closest('tr').find('td:eq(0)').text();
            dto = {
                PIC: columns
            }
            $.ajax({
                url: 'DeletePIC',
                type: 'post',
                dataType: 'json',
                data: JSON.stringify(dto),
                contentType: 'application/json; charset=utf-8',
                success: function (data) {
                    //console.log(data);
                    var Count = data.length;
                    $('#Table_PIC').DataTable().destroy();
                    $("#Tbl_PIC").empty();
                    //$("#AreaPIC_DDL").empty().prop('disabled', false);
                    //$("#PIC_DDL").empty().prop('disabled', false);
                    //$('#AreaPIC_DDL').append($('<option></option>').attr('value', '').text('*Select Area PIC*'));
                    if (Count > 0) {
                        $.each(data, function (key, entry) {
                            $('#Tbl_PIC').append($('<tr><td>' + entry.PIC + '</td><td>' + entry.Departemen + '</td><td hidden>' + entry.NIK + '</td><td hidden>' + entry.Email + '</td><td><button type="button" class="form-control-sm delete">Delete</button></td></tr>'));
                            //$('#AreaPIC_DDL').append($('<option></option>').attr('value', entry.SubDeptCode).text(entry.Departemen));
                            getTableRow();
                        })
                        $('#Table_PIC').DataTable({
                            autoWidth: false,
                            pageLength: 5,
                            lengthChange: false,
                            searching: false
                        });
                    } else {
                        $('#div_ListPIC').prop('hidden', true);
                    }
                    //$('#AreaPIC_DDL').append($('<option></option>').attr('value', 'Others').text('Others'));
                    //$('#AreaPIC_DDL').select2();
                },
                error: function (ex) {
                    alert(JSON.stringify(ex));
                }
            });
        });
    }

    function getTableRow() {
        var DeptList = new Array();
        var PICList = new Array();
        $("#Tbl_Departemen tr").each(function () {
            var row = $(this);
            var data = {};
            data.Departemen = row.find("td").eq(0).html();
            DeptList.push(data);
            $("#myObj").val(JSON.stringify(DeptList));
        });

        $("#Tbl_PIC tr").each(function () {
            var row = $(this);
            var data = {};
            data.PIC = row.find("td").eq(0).html();
            data.Departemen = row.find("td").eq(1).html();
            data.NIK = row.find("td").eq(2).html();
            data.Email = row.find("td").eq(3).html();
            PICList.push(data);
            $("#myObj2").val(JSON.stringify(PICList));
        });          
        console.log(PICList);
    }

    function TahunDDL() {
        var years = new Date().getFullYear();
        for (var i = years; i >= 2018; i--) {
            $('#Tahun_DDL').append(new Option(i, i));
            $('.TahunCCC').append(new Option(i, i));
            $('.TahunCAPA').append(new Option(i, i));
        }
    }

    function blockThread(_callback) {
        var kategori = $("#Kategori_DDL option:contains(" + data[0].KATEGORI_CAPA + ")").val();
        var lokasi = $("#Lokasi_DDL option:contains(" + data[0].LOKASI_CAPA + ")").val();

        $('#Trigger_CAPA').val(data[0].TRIGGER_CAPA).trigger("change");
        $('#Kategori_DDL').val(data[0].KATEGORI_CAPA).trigger("change");
        $('#TxtDeskripsi').val(data[0].DESKRIPSI_MASALAH).trigger("change");
        $("#Kategori_DDL").val(kategori).trigger("change");
        $("#Lokasi_DDL").val(lokasi).trigger("change");
        $.each(JSON.parse(data[0].DEPTLIST), function (key, value) {
            $("#AreaPIC_DDL").append(new Option(value.Departemen.trim(), value.Departemen.trim()));
        });
        $("#AreaPIC_DDL").val(data[0].AREA_PIC).trigger("change");
        _callback();
    }

    function clearInputEmail() {
        $('#TxtEmailVendor').val("");
        $('#TxtPICVendor').val("");
        $('#PIC_ID').val("");
    }

    function resetTable(_callback) {
        if (@Request.QueryString.Count == 0) {
            $.ajax({
                url: 'ResetDepartments',
                type: 'GET',
                success: function (data) {
                    $("#Tbl_Departemen").empty();
                    $('#List_Departemen').prop('hidden', true);
                    $("#AreaPIC_DDL").empty();
                    $("#PIC_DDL").empty();
                },
                error: function (ex) {
                    alert(JSON.stringify(ex));
                }
            });
        }
        _callback();
    }

    function resetPIC() {
        $.ajax({
            url: 'ResetPIC',
            type: 'GET',
            success: function (data) {
                $("#Tbl_PIC").empty();
                //$('#List_Departemen').prop('hidden', true);
                //$("#AreaPIC_DDL").empty();
                //$("#PIC_DDL").empty();
            },
            error: function (ex) {
                alert(JSON.stringify(ex));
            }
        });
    }

    function requestPage() {
        var defer = $.Deferred();
        if (@Request.QueryString.Count == 1) {
            $.blockUI();
            isHide = true;
            setTimeout(function () {
                getRequestPageData();
                defer.resolve();
            }, 1000);
        } else {
            getDDL();
            TahunDDL();
            DeleteDepartemen();
            DeletePIC();
            //checkUser($('#input_NIK').val());
        }
        return defer;
    }

    function getRequestPageData() {
        $.unblockUI();
        if (@Request.QueryString.Count == 1) {
            TableKajianPV();

            isHide = true;

            $('#Div_KajianResikoInput').prop('hidden', true);

            var result = $.ajax({
                url: 'GetCAPA',
                type: 'post',
                data: JSON.stringify({
                    Option: 10,
                    NO_CAPA: $('#input_NoCAPA').val(),
                    REG_ID: $('#input_REG_ID').val(),
                    SP: "[dbo].[SP_SHOW_DDL]"
                }),
                dataType: 'json',
                contentType: 'application/json; charset=utf-8',
                async: false
                //success: function (data) {

                //error: function (ex) {
                //    alert(JSON.stringify(ex));
                //}
            });
            var data = JSON.parse(result.responseText);
            //console.log(data);
            if (data != null) {
                $("#Kategori_DDL").select2();
                $("#Trigger_CAPA").select2();
                $("#Lokasi_DDL").select2();


                var d = new Date(data[0].Create_Date);
                var str = d.toLocaleDateString() + // 03/31/2022
                    ' ' + d.toTimeString().split(' ')[0] //+ // 12:34:56, GMT+0x00 (GMT+0x:00)
                    //' ' + (d.getMonth() + 101) + // 108
                    //' ' + d.getMilliseconds(); // 789
                //console.log(str); // Tue Aug 10 2010 12:34:56 108 789
                //console.log(//   $1 Tue  $2 Aug  $3 11     $4 2020 $5 12   $6 34   $7 56    $8 108  $9 789
                //    str.replace(/(\S{3}) (\S{3}) (\d{1,2}) (\d{4}) (\d{2}):(\d{2}):(\d{2}) 1(\d{2}) (\d{1,3})/, '$3-$2-$4 $5:$6')
                //);
                $("#date-format").val(str);

                $("#Trigger_CAPA").empty().append(new Option(data[0].TRIGGER_CAPA, data[0].TRIGGER_CAPA));
                $("#Kategori_DDL").empty().append(new Option(data[0].KATEGORI_CAPA, data[0].KATEGORI_CAPA2));
                $("#Lokasi_DDL").empty().append(new Option(data[0].LOKASI_CAPA, data[0].LOKASI_CAPA2));
                $("#Kode_DDL").empty().append(new Option(data[0].Kode_CAPA2, data[0].Kode_CAPA));
                $("#TxtEmailVendor").val(data[0].EMAIL);

                $('#input_Requestor').val(data[0].FullName);
                $('#input_Departemen').val(data[0].DEPT_PELAPOR);
                //$('#Trigger_CAPA').val(data[0].TRIGGER_CAPA).trigger("change");
                //$('#Kategori_DDL').val(data[0].KATEGORI_CAPA).trigger("change");

                $('#TxtKataKunci').val(data[0].Kata_Kunci).trigger("change");
                $('#TxtDeskripsi').val(data[0].DESKRIPSI_MASALAH).trigger("change");

                $.each(JSON.parse(data[0].DEPTLIST), function (key, value) {
                    $("#AreaPIC_DDL").append(new Option(value.Departemen.trim(), value.Departemen.trim()));
                });
                $("#PIC_DDL").empty().append(new Option(data[0].PIC_CAPA, data[0].PIC_CAPA));
                $("#PIC_DDL").val(data[0].PIC_CAPA).trigger("change");

                $('#link_CCC').modal('hide');
                $('#link_Deviation').modal('hide');
                $('#link_NoCAPATerkait').modal('hide');

                $.each(data[0].FILELIST, function (key, value) {
                    $('#Tbl_Lampiran').append($('<tr><td><a href="' + value + '" ><span style="color:black;">' + data[0].FILE_NAME[key] + '</span></a></td></tr>'))
                });

                $.each(data[0].PENYIMPANGANLIST, function (key, value) {
                    $('#Tbl_Penyimpangan').append($('<tr><td>' + value + '</td></tr>'))
                });

                var table = $('#Table_Departemen').DataTable({
                    "pageLength": 4,
                    "lengthChange": true,
                    "paging": false,
                    "info": false,
                    "searching": false,
                    "data": JSON.parse(data[0].DEPTLIST),
                    "select": true,
                    "bDestroy": true,
                    "scrollCollapse": true,
                    "columns": [
                        { "data": "Departemen" }
                    ]
                    //"order": [[1, 'asc']]
                });
            }
        }
    }

    //function checkUser(NIK) {
    //    $.ajax({
    //        url: 'CheckUser',
    //        type: 'post',
    //        data: JSON.stringify({
    //            Model: {
    //                Option: 19,
    //                NIK: NIK
    //            }
    //        }),
    //        dataType: 'json',
    //        contentType: 'application/json; charset=utf-8',
    //        async: false,
    //        success: function (data) {
    //            console.log(data);
    //            var val = JSON.parse(data);
    //            $('#Kategori_DDL').empty();
    //            $('#Kategori_DDL').append('<option disabled selected hidden class="dropdown-header">*Pilih*</option>');
    //            for (var code of val) {
    //                $('#Kategori_DDL').append(new Option(code.DDL_DESCRIPTION, code.DDL_CODE));
    //            }
    //        },
    //        error: function (ex) {
    //            alert(JSON.stringify(ex));
    //        }
    //    });
    //}

    function GetDeptNoCAPATerkait() {
        //alert('test');
        $.ajax({
            url: 'GetDepartments',
            type: 'post',
            dataType: 'json',
            data: JSON.stringify({
                Option: 8,
                SP: "[dbo].[SP_SHOW_DDL]"
            }),
            contentType: 'application/json; charset=utf-8',
            success: function (data) {
                $('#DepartemenPelapor_DDL').empty();
                $('#AreaPICCAPA_DDL').empty();
                $.each(JSON.parse(data), function (key, entry) {
                    //$('#DepartemenPelapor_DDL').append($('<option></option>').attr('value', entry.SubDeptCode).text(entry.SubDept));
                    $('#AreaPICCAPA_DDL').append($('<option></option>').attr('value', entry.SubDeptCode).text(entry.SubDept));

                })
            },
            error: function (ex) {
                alert(JSON.stringify(ex));
            }
        });
    }

    function GetDeptPenyimpangan() {
        $.ajax({
            url: 'GetDepartments',
            type: 'post',
            dataType: 'json',
            data: JSON.stringify({
                Option: 21,
                SP: "[dbo].[SP_SHOW_DDL]"
            }),
            contentType: 'application/json; charset=utf-8',
            success: function (data) {
                //console.log(data)
                $('#DepartemenPelapor_DDL').empty();
                $.each(JSON.parse(data), function (key, entry) {
                    $('#DepartemenPelapor_DDL').append($('<option></option>').attr('value', entry.Org_Group_Name).text(entry.Org_Group_Name));
                    // $('#AreaPICCAPA_DDL').append($('<option></option>').attr('value', entry.SubDeptCode).text(entry.SubDept));

                })
            },
            error: function (ex) {
                alert(JSON.stringify(ex));
            }
        });
    }

    function GetDepartements() {
        dto = {
            Option: 3,
            Departemen: $('#AreaPIC_DDL').val(),
            //Lokasi: Location,
            SP: "[dbo].[SP_SHOW_DDL]"
        }

        $.ajax({
            url: 'GetDepartments',
            type: 'post',
            dataType: 'json',
            data: JSON.stringify({
                Option: 2,
                Lokasi: $('#Lokasi_DDL').val().toString(),
                SP: "[dbo].[SP_SHOW_DDL]"
            }),
            contentType: 'application/json; charset=utf-8',
            success: function (data) {
                //console.log(data);
                resetTable(function _callback() {
                    $('#Departemen_DDL').empty();
                    $('#Departemen_DDL').append('<option disabled selected hidden class="dropdown-header">*Pilih*</option>');
                    $.each(JSON.parse(data), function (key, entry) {
                        $('#Departemen_DDL').append($('<option></option>').attr('value', entry.SubDeptCode).text(entry.Dept));
                        $('#DepartemenPelapor_DDL').append($('<option></option>').attr('value', entry.Dept).text(entry.Dept));

                    })
                    $('#Departemen_DDL').append($('<option></option>').attr('value', 'Others').text('Others'));
                    $('#Departemen_DDL').select2();
                });

            },
            error: function (ex) {
                alert(JSON.stringify(ex));
            }
        });
    }

    //function UpdateLampiran() {
    //    $.ajax({
    //        url: "./Lampiran",
    //        type: "post",
    //        data: formData,
    //        dataType: "json",
    //        contentType: false,
    //        processData: false,
    //        success: function (data) {
    //            console.log(data);
    //        },
    //        error: function (ex) {
    //            alert(JSON.stringify(ex));
    //        }
    //    });
    //}
</script>


